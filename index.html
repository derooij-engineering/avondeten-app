<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Avondeten Inspiratie ‚Äî met Weekplanning</title>

  <!-- PWA basics (optioneel, laat staan als je al een manifest & SW hebt) -->
  <meta name="theme-color" content="#f97316" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Avondeten" />
  <meta name="description" content="Ontdek, bewaar en plan jullie favoriete gerechten. Met weekplanning en boodschappenlijst." />

  <!-- Firebase compat SDKs (blijven gelijk aan jouw project) -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --brand: #f97316;
      --brand-600: #ea580c;
      --success: #10b981;
      --success-600: #059669;
      --danger: #ef4444;
      --danger-600: #dc2626;
      --muted: #6b7280;
      --card: #ffffff;
      --bg-grad-a: #fff7ed;
      --bg-grad-b: #fed7d7;
    }
    * { box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, var(--bg-grad-a) 0%, var(--bg-grad-b) 100%);
      margin: 0; padding: 16px; min-height: 100vh;
    }
    .container { max-width: 1200px; margin: 0 auto; }
    .header { text-align: center; margin-bottom: 24px; }
    .header h1 { margin: 0 0 6px; font-size: 2rem; color: #1f2937; }
    .header p { margin: 0; color: var(--muted); }

    .grid { display: grid; grid-template-columns: 1fr; gap: 24px; }
    @media (min-width: 1024px) { .grid { grid-template-columns: 2fr 1fr; } }

    .card { background: var(--card); border-radius: 12px; box-shadow: 0 4px 10px rgba(0,0,0,.06); padding: 20px; }
    .card-header { display: flex; justify-content: space-between; align-items: center; gap: 12px; margin-bottom: 16px; }
    .card-title { margin: 0; font-weight: 700; font-size: 1.25rem; color: #111827; }

    .btn { border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn-primary { background: var(--brand); color:#fff; }
    .btn-primary:hover { background: var(--brand-600); }
    .btn-success { background: var(--success); color:#fff; }
    .btn-success:hover { background: var(--success-600); }
    .btn-danger { background: var(--danger); color:#fff; }
    .btn-danger:hover { background: var(--danger-600); }
    .btn-ghost { background: #eef2ff; color:#1e3a8a; }

    .muted { color: var(--muted); }

    .recipe-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
    @media (min-width: 768px) { .recipe-grid { grid-template-columns: repeat(2, 1fr); } }

    .recipe-card { border: 1px solid #e5e7eb; border-radius: 10px; padding: 14px; transition: box-shadow .2s; cursor: pointer; background: #fff; }
    .recipe-card:hover { box-shadow: 0 6px 18px rgba(0,0,0,.08); }
    .recipe-title { margin:0 0 6px; font-weight: 700; color:#111827; }
    .recipe-meta { display:flex; gap:12px; font-size:.9rem; color: var(--muted); margin-bottom: 8px; }
    .tags { display:flex; flex-wrap: wrap; gap:6px; margin: 8px 0; }
    .tag { background:#fed7aa; color:#7c2d12; font-size:.75rem; padding: 3px 8px; border-radius: 999px; }

    .empty { text-align:center; color:var(--muted); padding: 24px 8px; }

    /* Weekplanner */
    .week-bar { display:flex; align-items:center; justify-content: space-between; gap: 8px; margin-bottom: 12px; }
    .week-when { font-weight: 600; }
    .week-grid { display:grid; grid-template-columns: repeat(7,1fr); gap: 10px; }
    @media (max-width: 900px) { .week-grid { grid-template-columns: 1fr; } }

    .day { background:#f8fafc; border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px; min-height: 110px; display:flex; flex-direction:column; gap:6px; cursor:pointer; }
    .day.today { border-color: var(--success); background:#ecfdf5; }
    .day-head { display:flex; align-items:center; justify-content:space-between; font-weight: 600; color:#111827; }
    .day-date { font-size:.8rem; color: var(--muted); }
    .day-meal { flex:1; display:flex; align-items:center; justify-content:center; text-align:center; font-size:.95rem; border:1px dashed #d1d5db; border-radius: 8px; color:#9ca3af; background:#fff; padding: 6px; }
    .day-meal.filled { border-color:#f59e0b; color:#7c2d12; background:#fff7ed; position:relative; }
    .day-remove { position:absolute; right: -6px; top:-6px; width: 22px; height:22px; border-radius: 50%; background: var(--danger); color:#fff; border:0; cursor:pointer; display:none; }
    .day-meal.filled:hover .day-remove { display:block; }

    /* Modal generic */
    .modal { position: fixed; inset: 0; display:none; align-items: center; justify-content: center; background: rgba(0,0,0,.45); padding: 16px; z-index: 50; }
    .modal.show { display: flex; }
    .modal-card { background:#fff; width: 100%; max-width: 620px; border-radius: 12px; padding: 18px; max-height: 85vh; overflow:auto; }
    .modal-head { display:flex; align-items:center; justify-content:space-between; gap: 8px; margin-bottom: 12px; }

    .row { display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .field { margin: 10px 0; }
    .label { display:block; font-weight:600; margin: 6px 0; color:#374151; }
    .input, .textarea, .select { width:100%; border:1px solid #d1d5db; border-radius: 8px; padding: 10px; font-size: 1rem; }
    .textarea { min-height: 120px; resize: vertical; }

    /* Ingredients selection list in plan modal */
    .ing-list { border:1px solid #e5e7eb; border-radius: 10px; padding: 10px; max-height: 260px; overflow: auto; background:#fff; }
    .ing-item { display:flex; align-items:center; gap: 10px; padding: 6px; border-radius: 8px; }
    .ing-item:hover { background:#f9fafb; }

    /* Shopping list */
    .shop-list { max-height: 460px; overflow:auto; }
    .shop-row { display:flex; align-items:center; gap: 10px; padding: 8px; border-radius: 8px; }
    .shop-row:hover { background:#f9fafb; }
    .shop-row.checked { color: var(--muted); text-decoration: line-through; }
    .icon-btn { background: transparent; border: 0; cursor:pointer; font-size: 1rem; }
    .icon-btn.danger { color: var(--danger); }
    .icon-btn.edit { color: #2563eb; }

    .hint { font-size:.85rem; color:#1e40af; background:#dbeafe; border-radius: 10px; padding: 10px; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è Avondeten Inspiratie</h1>
      <p>Weekplanning + boodschappenlijst (gedeeld via Firebase)</p>
    </div>

    <div class="grid">
      <!-- Weekplanning -->
      <section class="card" style="grid-column: 1 / -1;">
        <div class="card-header">
          <h2 class="card-title">üìÖ Weekplanning</h2>
          <div style="display:flex; gap:8px; align-items:center;">
            <button class="btn btn-ghost" id="prevWeekBtn">‚Üê Vorige week</button>
            <div class="week-when" id="weekLabel">Week</div>
            <button class="btn btn-ghost" id="nextWeekBtn">Volgende week ‚Üí</button>
          </div>
        </div>
        <div id="weekGrid" class="week-grid"></div>
      </section>

      <!-- Recepten -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Recepten Collectie</h2>
          <button class="btn btn-primary" id="addRecipeBtn">‚ûï Recept</button>
        </div>
        <div id="recipeGrid" class="recipe-grid"></div>
        <div id="recipeEmpty" class="empty" style="display:none;">Nog geen recepten. Voeg er eentje toe!</div>
      </section>

      <!-- Boodschappenlijst -->
      <section class="card">
        <div class="card-header">
          <h2 class="card-title">Boodschappenlijst</h2>
          <div style="display:flex; gap:8px;">
            <button class="btn btn-primary" id="copyListBtn" title="Kopieer naar klembord">üìã</button>
            <button class="btn btn-danger" id="clearListBtn" title="Alles wissen">üóëÔ∏è</button>
          </div>
        </div>
        <div id="shoppingEmpty" class="empty" style="display:none;">Leeg. Voeg ingredi√´nten toe vanuit een recept.</div>
        <div id="shoppingList" class="shop-list"></div>
        <div id="shoppingHint" class="hint" style="margin-top:10px; display:none;">üí° Tip: Kopieer (üìã) en plak in iPhone Herinneringen.</div>
      </section>
    </div>
  </div>

  <!-- Recept toevoegen/bewerken -->
  <div class="modal" id="recipeModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="recipeModalTitle" style="margin:0;">Nieuw recept</h3>
        <button class="icon-btn" id="recipeModalClose" aria-label="Sluiten">‚úñÔ∏è</button>
      </div>
      <div class="field">
        <label class="label">Titel *</label>
        <input id="f_title" class="input" placeholder="Bijv. Pasta pesto" />
      </div>
      <div class="row">
        <div class="field">
          <label class="label">Bereidingstijd</label>
          <input id="f_prep" class="input" placeholder="30 min" />
        </div>
        <div class="field">
          <label class="label">Porties</label>
          <input id="f_servings" class="input" placeholder="4 personen" />
        </div>
      </div>
      <div class="field">
        <label class="label">Tags (komma-gescheiden)</label>
        <input id="f_tags" class="input" placeholder="pasta, snel, italiaans" />
      </div>
      <div class="field">
        <label class="label">Ingredi√´nten * (√©√©n per regel)</label>
        <textarea id="f_ings" class="textarea" placeholder="200 g spaghetti\n100 g pesto\n250 g kip"></textarea>
      </div>
      <div class="field">
        <label class="label">Bereidingswijze</label>
        <textarea id="f_instr" class="textarea" placeholder="Kook de pasta‚Ä¶"></textarea>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 10px;">
        <button class="btn" id="recipeCancel">Annuleren</button>
        <button class="btn btn-success" id="recipeSave">Opslaan</button>
      </div>
    </div>
  </div>

  <!-- Dag plannen: recept kiezen + ingredi√´nten selecteren -->
  <div class="modal" id="planModal" aria-hidden="true">
    <div class="modal-card">
      <div class="modal-head">
        <h3 id="planModalTitle" style="margin:0;">Plan gerecht</h3>
        <button class="icon-btn" id="planModalClose" aria-label="Sluiten">‚úñÔ∏è</button>
      </div>
      <div class="field">
        <label class="label">Recept</label>
        <select id="planSelect" class="select"></select>
      </div>
      <div id="planIngsWrap" style="display:none;">
        <div class="label">Ingredi√´nten (vink aan wat naar de boodschappenlijst moet)</div>
        <div id="planIngs" class="ing-list"></div>
        <div style="display:flex; gap:8px; margin-top:10px;">
          <button class="btn btn-success" id="addSelectedBtn">+ Geselecteerde naar lijst</button>
          <button class="btn" id="addAllBtn">+ Alle naar lijst</button>
        </div>
      </div>
      <div style="display:flex; justify-content:flex-end; gap:10px; margin-top: 14px;">
        <button class="btn" id="planCancel">Annuleren</button>
        <button class="btn btn-primary" id="planSave">Dag opslaan</button>
      </div>
    </div>
  </div>

  <script>
    // ===== Firebase setup (laat jouw bestaande config hier staan) =====
    const firebaseConfig = {
      apiKey: "AIzaSyDwCytKLyfCWkaRvDoVVu_hUrTpuK3ef4Y",
      authDomain: "avondeten-inspiratie.firebaseapp.com",
      projectId: "avondeten-inspiratie",
      storageBucket: "avondeten-inspiratie.firebasestorage.app",
      messagingSenderId: "530227974284",
      appId: "1:530227974284:web:e101bcc416b51e0a58aba9",
      measurementId: "G-7JS0X2R3DB"
    };
    try { firebase.initializeApp(firebaseConfig); } catch (e) { /* noop if already init */ }
    const db = firebase.firestore();

    // ===== App State =====
    let recipes = [];                 // [{id, title, prepTime, servings, tags[], ingredients[], instructions, dateAdded}]
    let shoppingList = [];            // [{id, text, checked, editing?}]
    const weekPlans = {};             // { [weekKey]: { days: {0: {id,title}, ...}} }

    // Editing state
    let editingRecipeId = null;

    // ===== DOM =====
    const recipeGrid = document.getElementById('recipeGrid');
    const recipeEmpty = document.getElementById('recipeEmpty');
    const addRecipeBtn = document.getElementById('addRecipeBtn');

    const shoppingListEl = document.getElementById('shoppingList');
    const shoppingEmpty = document.getElementById('shoppingEmpty');
    const shoppingHint = document.getElementById('shoppingHint');
    const copyListBtn = document.getElementById('copyListBtn');
    const clearListBtn = document.getElementById('clearListBtn');

    const weekGrid = document.getElementById('weekGrid');
    const weekLabel = document.getElementById('weekLabel');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');

    // Recipe modal
    const recipeModal = document.getElementById('recipeModal');
    const recipeModalTitle = document.getElementById('recipeModalTitle');
    const recipeModalClose = document.getElementById('recipeModalClose');
    const f_title = document.getElementById('f_title');
    const f_prep = document.getElementById('f_prep');
    const f_servings = document.getElementById('f_servings');
    const f_tags = document.getElementById('f_tags');
    const f_ings = document.getElementById('f_ings');
    const f_instr = document.getElementById('f_instr');
    const recipeCancel = document.getElementById('recipeCancel');
    const recipeSave = document.getElementById('recipeSave');

    // Plan modal
    const planModal = document.getElementById('planModal');
    const planModalClose = document.getElementById('planModalClose');
    const planModalTitle = document.getElementById('planModalTitle');
    const planSelect = document.getElementById('planSelect');
    const planIngsWrap = document.getElementById('planIngsWrap');
    const planIngs = document.getElementById('planIngs');
    const addSelectedBtn = document.getElementById('addSelectedBtn');
    const addAllBtn = document.getElementById('addAllBtn');
    const planCancel = document.getElementById('planCancel');
    const planSave = document.getElementById('planSave');

    // ===== Utils =====
    function toISODate(d) { return d.toISOString().slice(0,10); }
    function mondayOf(d) {
      const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
      const day = x.getDay() || 7; // 1..7 (Mon..Sun)
      if (day !== 1) x.setDate(x.getDate() - (day - 1));
      x.setHours(0,0,0,0);
      return x;
    }
    function weekKeyOf(d) { return toISODate(mondayOf(d)); }
    function formatDM(d) { return `${String(d.getDate()).padStart(2,'0')}-${String(d.getMonth()+1).padStart(2,'0')}`; }
    function deepClone(obj){ return JSON.parse(JSON.stringify(obj)); }

    let currentWeekStart = mondayOf(new Date());

    // ===== Storage (Firestore + localStorage fallback) =====
    async function saveAll() {
      try {
        await db.collection('recipes').doc('shared').set({ recipes, lastUpdated: new Date() });
        await db.collection('shopping').doc('shared').set({ items: shoppingList, lastUpdated: new Date() });

        // keep only current and previous week in the shared doc
        const wk = weekKeyOf(currentWeekStart);
        const prev = weekKeyOf(new Date(currentWeekStart.getTime() - 7*24*3600*1000));
        const plansToKeep = {};
        if (weekPlans[wk]) plansToKeep[wk] = weekPlans[wk];
        if (weekPlans[prev]) plansToKeep[prev] = weekPlans[prev];
        await db.collection('weekplan').doc('shared').set({ plans: plansToKeep, lastUpdated: new Date() });

        // mirror to localStorage
        localStorage.setItem('recipes', JSON.stringify(recipes));
        localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
        localStorage.setItem('weekPlans', JSON.stringify(plansToKeep));
      } catch (e) {
        // Fallback to localStorage only
        localStorage.setItem('recipes', JSON.stringify(recipes));
        localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
        const wk = weekKeyOf(currentWeekStart);
        const prev = weekKeyOf(new Date(currentWeekStart.getTime() - 7*24*3600*1000));
        const plansToKeep = {};
        if (weekPlans[wk]) plansToKeep[wk] = weekPlans[wk];
        if (weekPlans[prev]) plansToKeep[prev] = weekPlans[prev];
        localStorage.setItem('weekPlans', JSON.stringify(plansToKeep));
      }
    }

    async function loadAll() {
      try {
        const [rSnap, sSnap, wSnap] = await Promise.all([
          db.collection('recipes').doc('shared').get(),
          db.collection('shopping').doc('shared').get(),
          db.collection('weekplan').doc('shared').get(),
        ]);
        if (rSnap.exists) recipes = rSnap.data().recipes || []; else recipes = JSON.parse(localStorage.getItem('recipes')||'[]');
        if (sSnap.exists) shoppingList = sSnap.data().items || []; else shoppingList = JSON.parse(localStorage.getItem('shoppingList')||'[]');
        if (wSnap.exists) Object.assign(weekPlans, wSnap.data().plans || {}); else Object.assign(weekPlans, JSON.parse(localStorage.getItem('weekPlans')||'{}'));
      } catch (e) {
        recipes = JSON.parse(localStorage.getItem('recipes')||'[]');
        shoppingList = JSON.parse(localStorage.getItem('shoppingList')||'[]');
        Object.assign(weekPlans, JSON.parse(localStorage.getItem('weekPlans')||'{}'));
      }
    }

    // ===== Weekplanner UI =====
    function updateWeekHeader() {
      const start = new Date(currentWeekStart);
      const end = new Date(currentWeekStart); end.setDate(end.getDate()+6);
      weekLabel.textContent = `Week van ${formatDM(start)} t/m ${formatDM(end)}`;

      // limit navigation: max 1 week terug, en niet verder dan huidige week vooruit
      const todayMon = mondayOf(new Date());
      const prevAllowed = mondayOf(new Date(todayMon.getTime() - 7*24*3600*1000));
      prevWeekBtn.disabled = currentWeekStart.getTime() <= prevAllowed.getTime() ? true : false;
      nextWeekBtn.disabled = currentWeekStart.getTime() >= todayMon.getTime();
    }

    function ensureWeekObj(weekKey){ if (!weekPlans[weekKey]) weekPlans[weekKey] = { days: {} }; }

    function renderWeek() {
      updateWeekHeader();
      const weekKey = weekKeyOf(currentWeekStart);
      ensureWeekObj(weekKey);

      const days = ['Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag','Zaterdag','Zondag'];
      const todayStr = new Date().toDateString();

      weekGrid.innerHTML = '';
      for (let i=0;i<7;i++){
        const date = new Date(currentWeekStart); date.setDate(date.getDate()+i);
        const isToday = date.toDateString() === todayStr;
        const chosen = weekPlans[weekKey].days[i]; // {id,title}
        const day = document.createElement('div');
        day.className = 'day' + (isToday ? ' today' : '');
        day.setAttribute('data-day', i);
        day.innerHTML = `
          <div class="day-head">
            <div>${days[i]}</div>
            <div class="day-date">${formatDM(date)}</div>
          </div>
          <div class="day-meal ${chosen ? 'filled' : ''}">
            ${chosen ? `${chosen.title}` : 'Klik om een gerecht te kiezen'}
            ${chosen ? '<button class="day-remove" title="Verwijderen">√ó</button>' : ''}
          </div>
        `;
        // Click handlers
        day.addEventListener('click', (ev) => {
          if (ev.target && ev.target.classList.contains('day-remove')){
            ev.stopPropagation();
            delete weekPlans[weekKey].days[i];
            saveAll();
            renderWeek();
          } else {
            openPlanModal(weekKey, i, date, chosen?.id || null);
          }
        });
        weekGrid.appendChild(day);
      }
    }

    prevWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate()-7); renderWeek(); });
    nextWeekBtn.addEventListener('click', () => { currentWeekStart.setDate(currentWeekStart.getDate()+7); renderWeek(); });

    // ===== Recepten =====
    function renderRecipes(){
      if (!recipes.length){ recipeGrid.innerHTML=''; recipeEmpty.style.display='block'; return; }
      recipeEmpty.style.display='none';
      recipeGrid.innerHTML = recipes.map(r => `
        <div class="recipe-card" onclick="viewRecipe(${r.id})">
          <div style="display:flex; justify-content:space-between; align-items:flex-start; gap:8px;">
            <h3 class="recipe-title">${escapeHtml(r.title)}</h3>
            <span>
              <button class="icon-btn edit" title="Bewerken" onclick="event.stopPropagation(); editRecipe(${r.id})">‚úèÔ∏è</button>
              <button class="icon-btn danger" title="Verwijderen" onclick="event.stopPropagation(); deleteRecipe(${r.id})">üóëÔ∏è</button>
            </span>
          </div>
          <div class="recipe-meta">
            ${r.prepTime ? `‚è±Ô∏è ${escapeHtml(r.prepTime)}` : ''}
            ${r.servings ? `‚Ä¢ üë• ${escapeHtml(r.servings)}` : ''}
          </div>
          ${r.tags?.length ? `<div class="tags">${r.tags.map(t=>`<span class='tag'>${escapeHtml(t)}</span>`).join('')}</div>` : ''}
          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:6px;">
            <small class="muted">Toegevoegd: ${escapeHtml(r.dateAdded||'')}</small>
            <button class="btn btn-ghost" onclick="event.stopPropagation(); addRecipeToShopping(${r.id})">+ Boodschappen</button>
          </div>
        </div>
      `).join('');
    }

    function openRecipeModal(editId=null){
      editingRecipeId = editId;
      if (editId){
        const r = recipes.find(x=>x.id===editId); if (!r) return;
        recipeModalTitle.textContent = 'Recept bewerken';
        f_title.value = r.title || '';
        f_prep.value = r.prepTime || '';
        f_servings.value = r.servings || '';
        f_tags.value = (r.tags||[]).join(', ');
        f_ings.value = (r.ingredients||[]).join('\n');
        f_instr.value = r.instructions || '';
      } else {
        recipeModalTitle.textContent = 'Nieuw recept';
        f_title.value = f_prep.value = f_servings.value = f_tags.value = f_instr.value = '';
        f_ings.value = '';
      }
      recipeModal.classList.add('show');
    }
    function closeRecipeModal(){ recipeModal.classList.remove('show'); }

    addRecipeBtn.addEventListener('click', ()=> openRecipeModal(null));
    recipeModalClose.addEventListener('click', closeRecipeModal);
    recipeCancel.addEventListener('click', closeRecipeModal);

    recipeSave.addEventListener('click', async () => {
      const title = f_title.value.trim();
      const ings = f_ings.value.trim();
      if (!title || !ings){ alert('Vul minimaal titel en ingredi√´nten in.'); return; }
      const r = {
        id: editingRecipeId || Date.now(),
        title,
        prepTime: f_prep.value.trim(),
        servings: f_servings.value.trim(),
        tags: f_tags.value.split(',').map(s=>s.trim()).filter(Boolean),
        ingredients: ings.split('\n').map(s=>s.trim()).filter(Boolean),
        instructions: f_instr.value.trim(),
        dateAdded: editingRecipeId ? (recipes.find(x=>x.id===editingRecipeId)?.dateAdded || new Date().toLocaleDateString('nl-NL')) : new Date().toLocaleDateString('nl-NL')
      };
      if (editingRecipeId){
        const i = recipes.findIndex(x=>x.id===editingRecipeId);
        if (i>=0) recipes[i]=r;
      } else {
        recipes.unshift(r);
      }
      await saveAll();
      renderRecipes();
      closeRecipeModal();
    });

    function editRecipe(id){ openRecipeModal(id); }
    function deleteRecipe(id){ if (confirm('Verwijderen?')){ recipes = recipes.filter(x=>x.id!==id); saveAll(); renderRecipes(); } }
    function viewRecipe(id){
      const r = recipes.find(x=>x.id===id); if (!r) return;
      alert(`${r.title}\n\nIngredi√´nten:\n${(r.ingredients||[]).join('\n')}\n\nBereiding:\n${r.instructions||'‚Äî'}`);
    }

    function addRecipeToShopping(id){
      const r = recipes.find(x=>x.id===id); if (!r) return;
      const toAdd = (r.ingredients||[]).map(t=>({ id: Date.now()+Math.random(), text: `${t} (${r.title})`, checked:false }));
      shoppingList.push(...toAdd);
      saveAll();
      renderShopping();
    }

    // ===== Dag plannen modal =====
    let planContext = { weekKey: null, dayIndex: null };
    function openPlanModal(weekKey, dayIndex, dateObj, selectedRecipeId){
      planContext = { weekKey, dayIndex };
      planModalTitle.textContent = `Gerecht voor ${dateObj.toLocaleDateString('nl-NL', { weekday:'long', day:'2-digit', month:'2-digit' })}`;

      // build select
      planSelect.innerHTML = `<option value="">‚Äî kies recept ‚Äî</option>` + recipes.map(r=>`<option value="${r.id}" ${selectedRecipeId===r.id? 'selected':''}>${escapeHtml(r.title)}</option>`).join('');
      planIngsWrap.style.display = 'none';
      planIngs.innerHTML = '';

      planModal.classList.add('show');
    }
    function closePlanModal(){ planModal.classList.remove('show'); }

    planModalClose.addEventListener('click', closePlanModal);
    planCancel.addEventListener('click', closePlanModal);

    planSelect.addEventListener('change', () => {
      const rid = parseInt(planSelect.value);
      if (!rid){ planIngsWrap.style.display='none'; planIngs.innerHTML=''; return; }
      const r = recipes.find(x=>x.id===rid); if (!r){ planIngsWrap.style.display='none'; return; }
      planIngsWrap.style.display = 'block';
      planIngs.innerHTML = (r.ingredients||[]).map((t,i)=>`
        <label class="ing-item">
          <input type="checkbox" data-idx="${i}" checked />
          <span>${escapeHtml(t)}</span>
        </label>
      `).join('');
    });

    addSelectedBtn.addEventListener('click', () => {
      const rid = parseInt(planSelect.value); if (!rid) return;
      const r = recipes.find(x=>x.id===rid); if (!r) return;
      const checks = planIngs.querySelectorAll('input[type="checkbox"]');
      const toAdd = [];
      checks.forEach((cb, i) => {
        if (cb.checked){ const t = r.ingredients[i]; toAdd.push({ id: Date.now()+Math.random(), text: `${t} (${r.title})`, checked:false }); }
      });
      if (toAdd.length){ shoppingList.push(...toAdd); saveAll(); renderShopping(); }
    });

    addAllBtn.addEventListener('click', () => {
      const rid = parseInt(planSelect.value); if (!rid) return;
      const r = recipes.find(x=>x.id===rid); if (!r) return;
      const toAdd = (r.ingredients||[]).map(t=>({ id: Date.now()+Math.random(), text: `${t} (${r.title})`, checked:false }));
      shoppingList.push(...toAdd); saveAll(); renderShopping();
    });

    planSave.addEventListener('click', async () => {
      const rid = parseInt(planSelect.value);
      if (!rid){ alert('Kies eerst een recept.'); return; }
      const r = recipes.find(x=>x.id===rid); if (!r) return;
      ensureWeekObj(planContext.weekKey);
      weekPlans[planContext.weekKey].days[planContext.dayIndex] = { id: r.id, title: r.title };
      await saveAll();
      renderWeek();
      closePlanModal();
    });

    // ===== Boodschappenlijst =====
    function renderShopping(){
      if (!shoppingList.length){ shoppingListEl.innerHTML=''; shoppingEmpty.style.display='block'; shoppingHint.style.display='none'; return; }
      shoppingEmpty.style.display='none'; shoppingHint.style.display='block';
      shoppingListEl.innerHTML = shoppingList.map(it => {
        if (it.editing){
          return `
            <div class="shop-row" data-id="${it.id}">
              <input type="checkbox" ${it.checked?'checked':''} onclick="toggleItem(${it.id}); event.stopPropagation();" />
              <input class="input" id="edit_${it.id}" value="${escapeAttr(it.text)}" style="flex:1;" />
              <button class="btn btn-success" onclick="saveEdit(${it.id})">Opslaan</button>
              <button class="btn" onclick="cancelEdit(${it.id})">Annuleren</button>
            </div>`;
        } else {
          return `
            <div class="shop-row ${it.checked?'checked':''}" data-id="${it.id}">
              <input type="checkbox" ${it.checked?'checked':''} onclick="toggleItem(${it.id}); event.stopPropagation();" />
              <span style="flex:1;">${escapeHtml(it.text)}</span>
              <button class="icon-btn edit" title="Wijzigen" onclick="startEdit(${it.id})">‚úèÔ∏è</button>
              <button class="icon-btn danger" title="Verwijderen" onclick="deleteItem(${it.id})">üóëÔ∏è</button>
            </div>`;
        }
      }).join('');
    }

    function toggleItem(id){ const it = shoppingList.find(x=>x.id===id); if (!it) return; it.checked=!it.checked; saveAll(); renderShopping(); }
    function startEdit(id){ const it = shoppingList.find(x=>x.id===id); if (!it) return; it.editing=true; renderShopping(); }
    function cancelEdit(id){ const it = shoppingList.find(x=>x.id===id); if (!it) return; delete it.editing; renderShopping(); }
    function saveEdit(id){ const it = shoppingList.find(x=>x.id===id); if (!it) return; const inp = document.getElementById(`edit_${id}`); it.text = inp.value.trim(); delete it.editing; saveAll(); renderShopping(); }
    function deleteItem(id){ shoppingList = shoppingList.filter(x=>x.id!==id); saveAll(); renderShopping(); }

    copyListBtn.addEventListener('click', () => {
      const text = shoppingList.filter(x=>!x.checked).map(x=>x.text).join('\n');
      if (!text) return;
      navigator.clipboard.writeText(text).then(()=> alert('Boodschappenlijst gekopieerd!')).catch(()=>{});
    });
    clearListBtn.addEventListener('click', ()=>{ if (confirm('Hele lijst wissen?')){ shoppingList=[]; saveAll(); renderShopping(); } });

    // ===== Helpers =====
    function escapeHtml(s){ return (s||'').replace(/[&<>"']/g, m=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[m])); }
    function escapeAttr(s){ return escapeHtml(s).replace(/"/g,'&quot;'); }

    // ===== Init =====
    (async function init(){
      await loadAll();
      // Guard: default to current week & optionally previous only
      const currKey = weekKeyOf(currentWeekStart);
      ensureWeekObj(currKey);
      const prevKey = weekKeyOf(new Date(currentWeekStart.getTime()-7*24*3600*1000));
      if (!weekPlans[prevKey]) { /* optional: keep empty until user goes back */ }

      renderRecipes();
      renderShopping();
      renderWeek();

      // Global handlers needed by inline HTML
      window.deleteRecipe = deleteRecipe;
      window.editRecipe = editRecipe;
      window.viewRecipe = viewRecipe;
      window.addRecipeToShopping = addRecipeToShopping;

      window.toggleItem = toggleItem;
      window.startEdit = startEdit;
      window.cancelEdit = cancelEdit;
      window.saveEdit = saveEdit;

      // Recipe modal openers
      window.openRecipeModal = openRecipeModal;
    })();
  </script>
</body>
</html>
