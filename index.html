<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Avondeten Inspiratie</title>

  <!-- PWA Meta -->
  <meta name="description" content="Ontdek, bewaar en plan jullie favoriete gerechten samen" />
  <meta name="theme-color" content="#f97316" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Avondeten" />

  <!-- Icon (inline) -->
  <link rel="apple-touch-icon" sizes="180x180" href="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTgwIiBoZWlnaHQ9IjE4MCIgdmlld0JveD0iMCAwIDE4MCAxODAiIGZpbGw9Im5vbmUiIHhtbG5zPSJodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyI+PHJlY3Qgd2lkdGg9IjE4MCIgaGVpZ2h0PSIxODAiIGZpbGw9IiNmOTczMTYiIHJ4PSIyMCIvPjxzdmcgeD0iNDAiIHk9IjQwIiB3aWR0aD0iMTAwIiBoZWlnaHQ9IjEwMCIgdmlld0JveD0iMCAwIDI0IDI0IiBmaWxsPSJ3aGl0ZSI+PHA+8J+NvTwvcD48L3N2Zz48L3N2Zz4="/>

  <!-- Manifest (inline blijft prima voor nu) -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkF2b25kZXRlbiBJbnNwaXJhdGllIiwKICAic2hvcnRfbmFtZSI6ICJBdm9uZGV0ZW4iLAogICJkZXNjcmlwdGlvbiI6ICJPbnRkZWssIGJld2FhciBlbiBwbGFuIGp1bGxpZSBmYXZvcmlldGUgZ2VyZWNodGVuIiwKICAic3RhcnRfdXJsIjogIi8iLAogICJkaXNwbGF5IjogInN0YW5kYWxvbmUiLAogICJiYWNrZ3JvdW5kX2NvbG9yIjogIiNmZmZmZmYiLAogICJ0aGVtZV9jb2xvciI6ICIjZjk3MzE2IiwKICAiaWNvbnMiOiBbXQp9">

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body {
      font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;
      background: linear-gradient(135deg,#fff7ed 0%,#fed7d7 100%);
      min-height:100vh; padding:16px;
    }
    .container { max-width:1200px; margin:0 auto; }
    .header { text-align:center; margin-bottom:32px; }
    .header h1 { font-size:2.5rem; color:#1f2937; margin-bottom:8px; }
    .header p { color:#6b7280; font-size:1.1rem; }

    .install-prompt { background:linear-gradient(135deg,#3b82f6,#1d4ed8); color:#fff; padding:16px; border-radius:12px; margin-bottom:24px; text-align:center; display:none; }
    .install-prompt.show { display:block; }
    .install-button { background:#fff; color:#3b82f6; border:none; padding:12px 24px; border-radius:8px; font-weight:600; cursor:pointer; margin-top:12px; }
    .install-button:hover { background:#f8fafc; }

    .main-grid { display:grid; grid-template-columns:1fr; gap:24px; }
    @media (min-width:1024px){ .main-grid { grid-template-columns:2fr 1fr; } }

    .card { background:#fff; border-radius:12px; box-shadow:0 4px 6px -1px rgba(0,0,0,.1); padding:24px; }
    .card-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:24px; }
    .card-title { font-size:1.5rem; font-weight:600; color:#1f2937; }

    .btn { padding:12px 16px; border-radius:8px; font-weight:500; border:none; cursor:pointer; display:inline-flex; align-items:center; gap:8px; transition:.2s; }
    .btn-primary{ background:#f97316; color:#fff; } .btn-primary:hover{ background:#ea580c; }
    .btn-success{ background:#10b981; color:#fff; } .btn-success:hover{ background:#059669; }
    .btn-danger{ background:#ef4444; color:#fff; } .btn-danger:hover{ background:#dc2626; }

    .recipe-grid { display:grid; grid-template-columns:1fr; gap:16px; }
    @media (min-width:768px){ .recipe-grid { grid-template-columns:repeat(2,1fr); } }

    .recipe-card { background:#fff; border:1px solid #e5e7eb; border-radius:8px; padding:16px; cursor:pointer; transition:.2s; }
    .recipe-card:hover { box-shadow:0 4px 12px -2px rgba(0,0,0,.1); }
    .recipe-title { font-size:1.125rem; font-weight:600; color:#1f2937; margin-bottom:8px; }
    .recipe-meta { display:flex; gap:16px; font-size:.875rem; color:#6b7280; margin-bottom:12px; }
    .recipe-tags { display:flex; flex-wrap:wrap; gap:4px; margin-bottom:12px; }
    .tag { background:#fed7aa; color:#c2410c; padding:4px 8px; border-radius:9999px; font-size:.75rem; }

    .shopping-list { max-height:400px; overflow-y:auto; }
    .shopping-item { display:flex; align-items:center; gap:12px; padding:8px; border-radius:6px; cursor:pointer; }
    .shopping-item:hover { background:#f9fafb; }
    .shopping-item.checked { color:#6b7280; text-decoration:line-through; }

    .modal { position:fixed; inset:0; background:rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; padding:16px; z-index:1000; }
    .modal-content { background:#fff; border-radius:12px; max-width:600px; width:100%; max-height:80vh; overflow-y:auto; padding:24px; }
    .form-group{ margin-bottom:16px; }
    .form-label{ display:block; font-size:.875rem; font-weight:500; color:#374151; margin-bottom:6px; }
    .form-input{ width:100%; padding:12px; border:1px solid #d1d5db; border-radius:6px; font-size:1rem; }
    .form-input:focus{ outline:none; border-color:#f97316; box-shadow:0 0 0 3px rgba(249,115,22,.1); }
    .form-textarea{ min-height:120px; resize:vertical; }

    .empty-state{ text-align:center; padding:48px 16px; color:#6b7280; }
    .empty-state-icon{ font-size:3rem; margin-bottom:16px; opacity:.3; }

    .offline-banner{ background:#fbbf24; color:#92400e; padding:12px; text-align:center; border-radius:8px; margin-bottom:16px; display:none; }
  </style>
</head>
<body>
  <div class="container">
    <!-- Install Prompt -->
    <div id="installPrompt" class="install-prompt">
      <div>üì± <strong>Installeer deze app!</strong></div>
      <div>Voeg toe aan je startscherm voor de beste ervaring</div>
      <button id="installButton" class="install-button">Installeren</button>
    </div>

    <!-- Offline Banner -->
    <div id="offlineBanner" class="offline-banner">
      üì° Je bent offline - wijzigingen worden opgeslagen wanneer je weer online bent
    </div>

    <!-- Header -->
    <div class="header">
      <h1>üçΩÔ∏è Avondeten Inspiratie</h1>
      <p>Ontdek, bewaar en plan jullie favoriete gerechten</p>
    </div>

    <!-- Main Grid -->
    <div class="main-grid">
      <!-- Recipes -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Recepten Collectie</h2>
          <button id="addRecipeBtn" class="btn btn-primary">‚ûï Recept Toevoegen</button>
        </div>

        <div id="recipeGrid" class="recipe-grid"></div>

        <div id="emptyRecipes" class="empty-state">
          <div class="empty-state-icon">üç≥</div>
          <p style="font-size:1.125rem; margin-bottom:8px;">Nog geen recepten toegevoegd</p>
          <p>Klik op "Recept Toevoegen" om te beginnen!</p>
        </div>
      </div>

      <!-- Shopping List -->
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">Boodschappenlijst</h2>
          <div style="display:flex; gap:8px;">
            <button id="copyListBtn" class="btn btn-primary" style="padding:8px;">üìã</button>
            <button id="clearListBtn" class="btn btn-danger" style="padding:8px;">üóëÔ∏è</button>
          </div>
        </div>

        <div id="shoppingList" class="shopping-list"></div>

        <div id="emptyShoppingList" class="empty-state">
          <div class="empty-state-icon">üõí</div>
          <p>Boodschappenlijst is leeg</p>
          <p style="font-size:.875rem;">Voeg ingredi√´nten toe vanuit recepten</p>
        </div>

        <div id="shoppingTip" style="margin-top:16px; padding:12px; background:#dbeafe; border-radius:8px; font-size:.875rem; color:#1e40af; display:none;">
          üí° Tip: Klik op üìã en plak in je iPhone Herinneringen app!
        </div>
      </div>
    </div>
  </div>

  <!-- Add / Edit Recipe Modal -->
  <div id="addRecipeModal" class="modal" style="display:none;">
    <div class="modal-content">
      <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:24px;">
        <h2 style="font-size:1.5rem; font-weight:600;">Nieuw Recept</h2>
        <button id="closeModal" style="background:none; border:none; font-size:1.5rem; cursor:pointer;">√ó</button>
      </div>

      <!-- URL/Manual Toggle -->
      <div style="display:flex; gap:8px; margin-bottom:20px;">
        <button type="button" id="manualBtn" class="btn btn-primary" style="flex:1;">‚úèÔ∏è Handmatig</button>
        <button type="button" id="urlBtn" class="btn" style="flex:1; background:#6b7280; color:#fff;">üîó Van URL</button>
      </div>

      <!-- URL Input -->
      <div id="urlSection" style="display:none;">
        <div class="form-group">
          <label class="form-label">Website URL *</label>
          <div style="display:flex; gap:8px;">
            <input id="recipeUrl" type="url" class="form-input" placeholder="https://www.ah.nl/allerhande/recept/...">
            <button type="button" id="extractBtn" class="btn btn-success" style="white-space:nowrap;">üîç Ophalen</button>
          </div>
          <div id="extractStatus" style="margin-top:8px; font-size:.875rem; color:#6b7280;"></div>
        </div>
      </div>

      <!-- Portion Calculator -->
      <div id="portionSection" style="display:none; margin-bottom:20px; padding:12px; background:#f0f9ff; border-radius:8px; border:1px solid #0ea5e9;">
        <div style="display:flex; align-items:center; gap:12px; margin-bottom:12px;">
          <label style="font-weight:500; color:#0c4a6e;">üçΩÔ∏è Aanpassen voor:</label>
          <input id="newPortions" type="number" min="1" max="20" value="3" style="width:60px; padding:6px; border:1px solid #bae6fd; border-radius:4px;">
          <span style="color:#0c4a6e;">personen</span>
          <button type="button" id="adjustPortionsBtn" class="btn" style="background:#0ea5e9; color:#fff; padding:6px 12px; font-size:.875rem;">üîÑ Aanpassen</button>
        </div>
        <div id="portionNote" style="font-size:.875rem; color:#075985;">
          üí° Tip: Dit past automatisch alle hoeveelheden aan in de ingredi√´nten
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Titel *</label>
        <input id="recipeTitle" type="text" class="form-input" placeholder="Heerlijke pasta carbonara">
      </div>

      <div style="display:grid; grid-template-columns:1fr 1fr; gap:16px;">
        <div class="form-group">
          <label class="form-label">Bereidingstijd</label>
          <input id="recipePrepTime" type="text" class="form-input" placeholder="30 min">
        </div>
        <div class="form-group">
          <label class="form-label">Porties</label>
          <input id="recipeServings" type="text" class="form-input" placeholder="4 personen">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">Tags (komma gescheiden)</label>
        <input id="recipeTags" type="text" class="form-input" placeholder="pasta, italiaans, snel">
      </div>

      <div class="form-group">
        <label class="form-label">Ingredi√´nten * (√©√©n per regel)</label>
        <textarea id="recipeIngredients" class="form-input form-textarea" placeholder="200g spaghetti&#10;100g pancetta&#10;3 eieren&#10;50g parmezaanse kaas"></textarea>
      </div>

      <div class="form-group">
        <label class="form-label">Bereidingswijze</label>
        <textarea id="recipeInstructions" class="form-input form-textarea" placeholder="Kook de pasta volgens de verpakking..."></textarea>
      </div>

      <div style="display:flex; justify-content:flex-end; gap:12px; margin-top:24px;">
        <button id="cancelBtn" class="btn" style="background:#f3f4f6; color:#374151;">Annuleren</button>
        <button id="saveRecipeBtn" class="btn btn-success">Recept Opslaan</button>
      </div>
    </div>
  </div>

  <script>
    // --- Firebase config (jouw huidige) ---
    const firebaseConfig = {
      apiKey: "AIzaSyDwCytKLyfCWkaRvDoVVu_hUrTpuK3ef4Y",
      authDomain: "avondeten-inspiratie.firebaseapp.com",
      projectId: "avondeten-inspiratie",
      storageBucket: "avondeten-inspiratie.firebasestorage.app",
      messagingSenderId: "530227974284",
      appId: "1:530227974284:web:e101bcc416b51e0a58aba9",
      measurementId: "G-7JS0X2R3DB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- App state ---
    let recipes = [];
    let shoppingList = [];
    let editingRecipeId = null;

    // --- PWA: Service Worker (ECHT bestand) ---
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/sw.js')
        .then(() => console.log('Service Worker geregistreerd'))
        .catch(err => console.log('Service Worker registratie gefaald', err));
    }

    // --- PWA Install Prompt ---
    let deferredPrompt;
    const installPrompt = document.getElementById('installPrompt');
    const installButton = document.getElementById('installButton');

    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      installPrompt.classList.add('show');
    });

    installButton.addEventListener('click', async () => {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        await deferredPrompt.userChoice;
        deferredPrompt = null;
        installPrompt.classList.remove('show');
      }
    });

    // --- Offline banner ---
    const offlineBanner = document.getElementById('offlineBanner');
    const updateOfflineBanner = () => {
      offlineBanner.style.display = navigator.onLine ? 'none' : 'block';
    };
    window.addEventListener('online', updateOfflineBanner);
    window.addEventListener('offline', updateOfflineBanner);
    updateOfflineBanner();

    // --- DOM refs ---
    const addRecipeBtn = document.getElementById('addRecipeBtn');
    const addRecipeModal = document.getElementById('addRecipeModal');
    const closeModal = document.getElementById('closeModal');
    const cancelBtn = document.getElementById('cancelBtn');
    const saveRecipeBtn = document.getElementById('saveRecipeBtn');
    const recipeGrid = document.getElementById('recipeGrid');
    const emptyRecipes = document.getElementById('emptyRecipes');
    const shoppingListEl = document.getElementById('shoppingList');
    const emptyShoppingList = document.getElementById('emptyShoppingList');
    const shoppingTip = document.getElementById('shoppingTip');
    const copyListBtn = document.getElementById('copyListBtn');
    const clearListBtn = document.getElementById('clearListBtn');

    // --- Modal helpers ---
    function openModal() {
      addRecipeModal.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function closeModalFunc() {
      addRecipeModal.style.display = 'none';
      document.body.style.overflow = 'auto';
      clearForm();
      // Reset modal
      editingRecipeId = null;
      document.querySelector('#addRecipeModal h2').textContent = 'Nieuw Recept';
      saveRecipeBtn.textContent = 'Recept Opslaan';
      document.getElementById('portionSection').style.display = 'none';
      document.getElementById('portionNote').innerHTML = 'üí° Tip: Dit past automatisch alle hoeveelheden aan in de ingredi√´nten';
      document.getElementById('portionNote').style.color = '#075985';
    }
    function clearForm() {
      document.getElementById('recipeTitle').value = '';
      document.getElementById('recipePrepTime').value = '';
      document.getElementById('recipeServings').value = '';
      document.getElementById('recipeTags').value = '';
      document.getElementById('recipeIngredients').value = '';
      document.getElementById('recipeInstructions').value = '';
      const urlEl = document.getElementById('recipeUrl');
      const statusEl = document.getElementById('extractStatus');
      if (urlEl) urlEl.value = '';
      if (statusEl) statusEl.textContent = '';
    }

    // --- Event listeners (modal open/close) ---
    addRecipeBtn.addEventListener('click', openModal);
    closeModal.addEventListener('click', closeModalFunc);
    cancelBtn.addEventListener('click', closeModalFunc);

    // --- URL/Manual toggle ---
    const manualBtn = document.getElementById('manualBtn');
    const urlBtn = document.getElementById('urlBtn');
    const urlSection = document.getElementById('urlSection');
    const extractBtn = document.getElementById('extractBtn');
    const extractStatus = document.getElementById('extractStatus');
    let currentMode = 'manual';

    manualBtn.addEventListener('click', () => {
      currentMode = 'manual';
      manualBtn.className = 'btn btn-primary';
      urlBtn.className = 'btn';
      urlBtn.style.background = '#6b7280';
      urlBtn.style.color = '#fff';
      urlSection.style.display = 'none';
    });
    urlBtn.addEventListener('click', () => {
      currentMode = 'url';
      urlBtn.className = 'btn btn-primary';
      manualBtn.className = 'btn';
      manualBtn.style.background = '#6b7280';
      manualBtn.style.color = '#fff';
      urlSection.style.display = 'block';
    });

    // --- URL extract flow ---
    extractBtn.addEventListener('click', async () => {
      const url = document.getElementById('recipeUrl').value.trim();
      if (!url) { alert('Vul eerst een URL in'); return; }

      extractStatus.textContent = 'üîÑ Recept ophalen...';
      extractBtn.disabled = true;
      try {
        const extractedData = await extractRecipeFromUrl(url);
        if (extractedData.success) {
          document.getElementById('recipeTitle').value = extractedData.title || '';
          document.getElementById('recipePrepTime').value = extractedData.prepTime || '';
          document.getElementById('recipeServings').value = extractedData.servings || '';
          document.getElementById('recipeIngredients').value = extractedData.ingredients || '';
          document.getElementById('recipeInstructions').value = extractedData.instructions || '';
          document.getElementById('recipeTags').value = extractedData.tags || '';
          extractStatus.innerHTML = `‚úÖ Recept opgehaald! ${extractedData.confidence}% betrouwbaarheid`;
          extractStatus.style.color = '#10b981';
        } else {
          extractStatus.innerHTML = `‚ùå ${extractedData.error}`;
          extractStatus.style.color = '#ef4444';
        }
      } catch (err) {
        extractStatus.innerHTML = '‚ùå Fout bij ophalen recept. Probeer handmatig invoeren.';
        extractStatus.style.color = '#ef4444';
      }
      extractBtn.disabled = false;
    });

    async function extractRecipeFromUrl(url) {
      try {
        extractStatus.innerHTML = 'üîÑ Bezig met ophalen...';
        const proxies = [
          `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
          `https://corsproxy.io/?${encodeURIComponent(url)}`,
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
        ];
        let htmlContent = null;

        extractStatus.innerHTML = 'üîÑ Proberen verschillende servers...';
        for (let i = 0; i < proxies.length; i++) {
          const proxy = proxies[i];
          try {
            extractStatus.innerHTML = `üîÑ Server ${i + 1}/${proxies.length} proberen...`;
            const response = await fetch(proxy);
            if (!response.ok) continue;
            const data = await response.text();
            htmlContent = proxy.includes('allorigins') ? JSON.parse(data).contents : data;
            if (htmlContent && htmlContent.length > 1000) break;
          } catch(e) { /* try next proxy */ }
        }
        if (!htmlContent) {
          return { success:false, error:'Kon website niet laden (CORS/anti-bot). Probeer handmatig kopi√´ren.' };
        }

        const parser = new DOMParser();
        const doc = parser.parseFromString(htmlContent, 'text/html');
        extractStatus.innerHTML = 'üîÑ Receptgegevens zoeken...';

        return tryExtractStrategies(doc, url);
      } catch (error) {
        return { success:false, error:`Technische fout: ${error.message}` };
      }
    }

    function tryExtractStrategies(doc, url) {
      // 1) JSON-LD
      const jsonLdData = extractFromJsonLd(doc);
      if (jsonLdData.success) return { ...jsonLdData, confidence:95 };
      // 2) Site-specifiek
      if (url.includes('allerhande.nl') || url.includes('ah.nl')) {
        const ah = extractFromAllerhande(doc);
        if (ah.success) return { ...ah, confidence:85 };
      }
      if (url.includes('smulweb.nl')) {
        const sw = extractFromSmulweb(doc);
        if (sw.success) return { ...sw, confidence:85 };
      }
      // 3) Generiek
      const generic = extractFromGenericHtml(doc);
      if (generic.success) return { ...generic, confidence:60 };
      return { success:false, error:'Geen receptgegevens gevonden op deze pagina' };
    }

    function extractFromJsonLd(doc) {
      try {
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for (let script of scripts) {
          try {
            const data = JSON.parse(script.textContent);
            const items = Array.isArray(data) ? data : [data];
            for (let item of items) {
              const recipe = (item['@type'] === 'Recipe') ? item
                : (item['@graph'] && item['@graph'].find(g => g['@type'] === 'Recipe'));
              if (!recipe) continue;

              const ingredients =
                recipe.recipeIngredient
                  ? (Array.isArray(recipe.recipeIngredient) ? recipe.recipeIngredient.join('\n') : recipe.recipeIngredient)
                  : '';

              let instructions = '';
              if (Array.isArray(recipe.recipeInstructions)) {
                instructions = recipe.recipeInstructions
                  .map(inst => (typeof inst === 'string' ? inst : (inst.text || '')))
                  .filter(Boolean)
                  .join('\n');
              } else if (typeof recipe.recipeInstructions === 'string') {
                instructions = recipe.recipeInstructions;
              }

              const tags = [
                recipe.recipeCategory, recipe.recipeCuisine
              ].filter(Boolean).join(', ');

              return {
                success:true,
                title: recipe.name || '',
                ingredients, instructions,
                prepTime: recipe.prepTime || recipe.totalTime || '',
                servings: recipe.recipeYield || recipe.yield || '',
                tags
              };
            }
          } catch(e){ /* continue */ }
        }
      } catch(err){ /* ignore */ }
      return { success:false };
    }

    function extractFromAllerhande(doc) {
      try {
        const title = doc.querySelector('h1, .recipe-header__title, [data-testhook="recipe-title"]')?.textContent?.trim() || '';
        let ingredients = '';
        const ingredientSelectors = [
          '[data-testhook="recipe-ingredient"]',
          '.recipe-ingredients__item',
          '.ingredients-list__item',
          '.recipe-ingredient',
          'li[class*="ingredient"]',
          '.ah-ingredient'
        ];
        for (const sel of ingredientSelectors) {
          const els = doc.querySelectorAll(sel);
          if (els.length) {
            ingredients = Array.from(els).map(el => (el.textContent||'').trim().replace(/\s+/g,' ')).filter(Boolean).join('\n');
            if (ingredients) break;
          }
        }

        let instructions = '';
        const instructionSelectors = [
          '[data-testhook="recipe-instruction"]',
          '.recipe-method__step',
          '.recipe-instructions__step',
          '.preparation-step',
          'ol li, .steps li'
        ];
        for (const sel of instructionSelectors) {
          const els = doc.querySelectorAll(sel);
          if (els.length) {
            instructions = Array.from(els).map((el,i) => {
              const txt = (el.textContent||'').trim().replace(/\s+/g,' ');
              return txt.length>3 ? `${i+1}. ${txt}` : '';
            }).filter(Boolean).join('\n\n');
            if (instructions) break;
          }
        }

        let prepTime = '';
        const prepTimeSelectors = [
          '[data-testhook="recipe-duration"]','.recipe-time','.prep-time','.cooking-time','[class*="duration"]','[class*="time"]'
        ];
        for (const sel of prepTimeSelectors) {
          const el = doc.querySelector(sel);
          if (el && el.textContent) { prepTime = el.textContent.trim(); if (prepTime) break; }
        }

        let servings = '';
        const servingSelectors = [
          '[data-testhook="recipe-portions"]','.recipe-portions','.servings','.yield','[class*="portion"]','[class*="serving"]'
        ];
        for (const sel of servingSelectors) {
          const el = doc.querySelector(sel);
          if (el && el.textContent) { servings = el.textContent.trim(); if (servings) break; }
        }

        if (title && (ingredients || instructions)) {
          return {
            success:true,
            title,
            ingredients: ingredients || 'Geen ingredi√´nten gevonden - vul handmatig aan',
            instructions: instructions || 'Geen instructies gevonden - vul handmatig aan',
            prepTime, servings, tags:'allerhande'
          };
        }
      } catch(e){ /* ignore */ }
      return { success:false };
    }

    function extractFromSmulweb(doc) {
      try {
        const title = doc.querySelector('h1, .recipe-title')?.textContent?.trim() || '';
        const ingredientElements = doc.querySelectorAll('.ingredients li, .recipe-ingredients li');
        const ingredients = Array.from(ingredientElements).map(el => el.textContent.trim()).join('\n');
        const instructionElements = doc.querySelectorAll('.directions li, .instructions li, .recipe-method li');
        const instructions = Array.from(instructionElements).map(el => el.textContent.trim()).join('\n');
        if (title && ingredients) {
          return { success:true, title, ingredients, instructions, prepTime:'', servings:'', tags:'smulweb' };
        }
      } catch(e){ /* ignore */ }
      return { success:false };
    }

    function extractFromGenericHtml(doc) {
      try {
        const titleSelectors = ['h1','.recipe-title','.entry-title','[class*="title"]','title'];
        let title = '';
        for (const sel of titleSelectors) {
          const el = doc.querySelector(sel);
          if (el) { title = (el.textContent||'').trim(); if (title && title.length>3) break; }
        }

        const ingredientSelectors = [
          '.ingredients li','.recipe-ingredients li','ul li','ol li','[class*="ingredient"] li','li[class*="ingredient"]'
        ];
        let ingredients = '';
        for (const sel of ingredientSelectors) {
          const els = doc.querySelectorAll(sel);
          if (els.length >= 3) {
            const possible = Array.from(els).map(el => (el.textContent||'').trim().replace(/\s+/g,' '))
              .filter(t => t.length>2 && (/\d/.test(t) || /(gram|ml|liter|stuks?|eetlepels?|theelepels?|kilo|pond|g|l|kg|el|tl)\b/i.test(t) || t.length<50));
            if (possible.length >= 3) { ingredients = possible.join('\n'); break; }
          }
        }

        const instructionSelectors = [
          '.instructions li','.recipe-method li','.directions li','.preparation li','ol li','[class*="instruction"] li'
        ];
        let instructions = '';
        for (const sel of instructionSelectors) {
          const els = doc.querySelectorAll(sel);
          if (els.length >= 2) {
            const possible = Array.from(els).map((el,i) => {
              const t = (el.textContent||'').trim(); return t.length>10 ? `${i+1}. ${t.replace(/\s+/g,' ')}` : '';
            }).filter(Boolean);
            if (possible.length >= 2) { instructions = possible.join('\n\n'); break; }
          }
        }

        if (title && (ingredients || instructions)) {
          return { success:true, title, ingredients:ingredients||'Geen ingredi√´nten gevonden - vul handmatig aan', instructions:instructions||'Geen instructies gevonden - vul handmatig aan', prepTime:'', servings:'', tags:'generic' };
        }
      } catch(e){ /* ignore */ }
      return { success:false };
    }

    // --- Firestore save/load ---
    function saveData() {
      try {
        db.collection('recipes').doc('shared').set({ recipes, lastUpdated:new Date() });
        db.collection('shopping').doc('shared').set({ items:shoppingList, lastUpdated:new Date() });
      } catch (error) {
        console.error('Error saving to Firebase:', error);
        localStorage.setItem('recipes', JSON.stringify(recipes));
        localStorage.setItem('shoppingList', JSON.stringify(shoppingList));
      }
    }

    function loadData() {
      db.collection('recipes').doc('shared').get().then(doc => {
        recipes = doc.exists ? (doc.data().recipes||[]) : [];
        renderRecipes();
      }).catch(() => {
        recipes = JSON.parse(localStorage.getItem('recipes') || '[]');
        renderRecipes();
      });

      db.collection('shopping').doc('shared').get().then(doc => {
        shoppingList = doc.exists ? (doc.data().items||[]) : [];
        renderShoppingList();
      }).catch(() => {
        shoppingList = JSON.parse(localStorage.getItem('shoppingList') || '[]');
        renderShoppingList();
      });
    }

    // --- Portion adjust ---
    document.getElementById('adjustPortionsBtn').addEventListener('click', () => {
      const newPortions = parseInt(document.getElementById('newPortions').value);
      const currentIngredients = document.getElementById('recipeIngredients').value;
      if (!newPortions || newPortions < 1) { alert('Vul een geldig aantal personen in'); return; }
      const adjusted = adjustIngredientPortions(currentIngredients, newPortions);
      document.getElementById('recipeIngredients').value = adjusted;
      document.getElementById('recipeServings').value = `${newPortions} personen`;
      const note = document.getElementById('portionNote');
      note.innerHTML = `‚úÖ Ingredi√´nten aangepast voor ${newPortions} personen!`;
      note.style.color = '#059669';
    });

    function adjustIngredientPortions(ingredientsText, newPortions) {
      const lines = ingredientsText.split('\n');
      const originalPortions = 4; // eenvoudige aanname
      const multiplier = newPortions / originalPortions;
      return lines.map(line =>
        line.replace(
          /^(\d+(?:\.\d+)?)\s*(gram|g|ml|liter|l|kg|stuks?|eetlepels?|theelepels?|el|tl)\b/i,
          (m, amount, unit) => {
            const newAmt = Math.round(parseFloat(amount) * multiplier * 10) / 10;
            return `${newAmt} ${unit}`;
          }
        )
      ).join('\n');
    }

    // --- Save / Edit recipe ---
    saveRecipeBtn.addEventListener('click', () => {
      const title = document.getElementById('recipeTitle').value.trim();
      const ingredients = document.getElementById('recipeIngredients').value.trim();
      if (!title || !ingredients) { alert('Vul minimaal titel en ingredi√´nten in'); return; }

      const recipe = {
        id: editingRecipeId || Date.now(),
        title,
        prepTime: document.getElementById('recipePrepTime').value,
        servings: document.getElementById('recipeServings').value,
        tags: document.getElementById('recipeTags').value.split(',').map(t => t.trim()).filter(Boolean),
        ingredients: ingredients.split('\n').map(s => s.trim()).filter(Boolean),
        instructions: document.getElementById('recipeInstructions').value,
        dateAdded: editingRecipeId
          ? (recipes.find(r => r.id === editingRecipeId)?.dateAdded || new Date().toLocaleDateString('nl-NL'))
          : new Date().toLocaleDateString('nl-NL')
      };

      if (editingRecipeId) {
        const idx = recipes.findIndex(r => r.id === editingRecipeId);
        if (idx !== -1) recipes[idx] = recipe;
      } else {
        recipes.unshift(recipe);
      }

      saveData();
      renderRecipes();
      closeModalFunc();
    });

    // --- Shopping list buttons ---
    copyListBtn.addEventListener('click', () => {
      const unchecked = shoppingList.filter(i => !i.checked).map(i => i.text).join('\n');
      if (unchecked) {
        navigator.clipboard.writeText(unchecked).then(() => {
          alert('Boodschappenlijst gekopieerd! üìã\nPlak in je iPhone Herinneringen app.');
        });
      }
    });

    clearListBtn.addEventListener('click', () => {
      if (confirm('Wil je de hele boodschappenlijst wissen?')) {
        shoppingList = [];
        saveData();
        renderShoppingList();
      }
    });

    // --- Global actions ---
    function deleteRecipe(id) {
      if (confirm('Weet je zeker dat je dit recept wilt verwijderen?')) {
        recipes = recipes.filter(r => r.id !== id);
        saveData(); renderRecipes();
      }
    }
    function addToShopping(recipeId) {
      const r = recipes.find(x => x.id === recipeId);
      if (r) {
        const items = (r.ingredients||[]).map(ing => ({
          id: Date.now() + Math.random(),
          text: (ing||'').replace(/^-\s*/, '').trim(),
          checked:false
        }));
        shoppingList.push(...items);
        saveData(); renderShoppingList();
      }
    }
    function viewRecipe(id) {
      const r = recipes.find(x => x.id === id);
      if (r) {
        alert(`${r.title}\n\nIngredi√´nten:\n${(r.ingredients||[]).join('\n')}\n\nBereidingswijze:\n${r.instructions || 'Geen instructies toegevoegd'}`);
      }
    }
    function toggleShoppingItem(id) {
      const it = shoppingList.find(x => x.id === id);
      if (it) { it.checked = !it.checked; saveData(); renderShoppingList(); }
    }
    window.deleteRecipe = deleteRecipe;
    window.addToShopping = addToShopping;
    window.viewRecipe = viewRecipe;
    window.toggleShoppingItem = toggleShoppingItem;

    // --- Renderers ---
    function renderRecipes() {
      if (!recipes.length) {
        recipeGrid.style.display = 'none';
        emptyRecipes.style.display = 'block';
        return;
      }
      recipeGrid.style.display = 'grid';
      emptyRecipes.style.display = 'none';

      recipeGrid.innerHTML = recipes.map(recipe => `
        <div class="recipe-card" onclick="viewRecipe(${recipe.id})">
          <div style="display:flex; justify-content:space-between; align-items:start;">
            <h3 class="recipe-title">${recipe.title}</h3>
            <div style="display:flex; gap:4px;">
              <button onclick="event.stopPropagation(); (function(){ 
                const r = ${recipe.id}; 
                (${editRecipe.toString()})(r);
              })()" style="background:none; border:none; color:#3b82f6; cursor:pointer; font-size:1.2rem;">‚úèÔ∏è</button>
              <button onclick="event.stopPropagation(); deleteRecipe(${recipe.id})" style="background:none; border:none; color:#ef4444; cursor:pointer; font-size:1.2rem;">üóëÔ∏è</button>
            </div>
          </div>

          <div class="recipe-meta">
            ${recipe.prepTime ? `<span>‚è±Ô∏è ${recipe.prepTime}</span>` : ''}
            ${recipe.servings ? `<span>üë• ${recipe.servings}</span>` : ''}
          </div>

          ${(recipe.tags && recipe.tags.length) ? `
            <div class="recipe-tags">
              ${recipe.tags.map(tag => `<span class="tag">${tag}</span>`).join('')}
            </div>` : ''}

          <div style="display:flex; justify-content:space-between; align-items:center; margin-top:12px;">
            <span style="font-size:.75rem; color:#6b7280;">Toegevoegd: ${recipe.dateAdded}</span>
            <button onclick="event.stopPropagation(); addToShopping(${recipe.id})" class="btn" style="background:#3b82f6; color:#fff; padding:6px 12px; font-size:.875rem;">+ Boodschappen</button>
          </div>
        </div>
      `).join('');
    }

    function renderShoppingList() {
      if (!shoppingList.length) {
        shoppingListEl.style.display = 'none';
        emptyShoppingList.style.display = 'block';
        shoppingTip.style.display = 'none';
        return;
      }
      shoppingListEl.style.display = 'block';
      emptyShoppingList.style.display = 'none';
      shoppingTip.style.display = 'block';

      shoppingListEl.innerHTML = shoppingList.map(item => `
        <div class="shopping-item ${item.checked ? 'checked' : ''}" onclick="toggleShoppingItem(${item.id})">
          <input type="checkbox" ${item.checked ? 'checked' : ''} style="width:16px; height:16px;">
          <span style="flex:1;">${item.text}</span>
        </div>
      `).join('');
    }

    // --- Edit flow (exposed) ---
    function editRecipe(id) {
      const recipe = recipes.find(r => r.id === id);
      if (!recipe) return;
      editingRecipeId = id;

      document.querySelector('#addRecipeModal h2').textContent = 'Recept Bewerken';
      saveRecipeBtn.textContent = 'Wijzigingen Opslaan';
      document.getElementById('portionSection').style.display = 'block';

      document.getElementById('recipeTitle').value = recipe.title;
      document.getElementById('recipePrepTime').value = recipe.prepTime || '';
      document.getElementById('recipeServings').value = recipe.servings || '';
      document.getElementById('recipeTags').value = (recipe.tags||[]).join(', ');
      document.getElementById('recipeIngredients').value = (recipe.ingredients||[]).join('\n');
      document.getElementById('recipeInstructions').value = recipe.instructions || '';

      openModal();
    }
    window.editRecipe = editRecipe;

    // --- Init ---
    loadData();
  </script>
</body>
</html>
