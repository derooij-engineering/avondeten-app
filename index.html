<!DOCTYPE html>
<html lang="nl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Avondeten Inspiratie</title>

  <!-- PWA meta -->
  <meta name="theme-color" content="#f97316" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="Avondeten" />

  <!-- Firebase (compat v9) -->
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>

  <style>
    :root {
      --brand: #f97316;
      --brand-dark: #ea580c;
      --ok: #10b981;
      --ok-dark: #059669;
      --danger: #ef4444;
      --muted: #6b7280;
      --panel: #ffffff;
      --soft: #f9fafb;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0; padding: 16px; min-height: 100vh;
      font-family: -apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Arial,sans-serif;
      background: linear-gradient(135deg, #fff7ed 0%, #fed7d7 100%);
      color: #111827;
    }
    .container { max-width: 1100px; margin: 0 auto; }
    .header { text-align: center; margin: 0 0 20px; }
    .header h1 { margin: 0 0 6px; font-size: 28px; }
    .header p { margin: 0; color: var(--muted); }

    .grid { display: grid; gap: 16px; grid-template-columns: 1fr; }
    @media (min-width: 980px) {
      .grid { grid-template-columns: 2fr 1fr; }
    }

    .card { background: var(--panel); border-radius: 12px; padding: 16px; box-shadow: 0 4px 12px rgba(0,0,0,.06); }
    .card h2 { margin: 0; font-size: 18px; }

    .btn { border: 0; border-radius: 10px; padding: 10px 14px; font-weight: 600; cursor: pointer; display: inline-flex; align-items: center; gap: 8px; }
    .btn:disabled { opacity:.5; cursor:not-allowed; }
    .btn-prim { background: var(--brand); color: #fff; }
    .btn-prim:hover { background: var(--brand-dark); }
    .btn-ok { background: var(--ok); color:#fff; }
    .btn-ok:hover { background: var(--ok-dark); }
    .btn-ghost { background: #e5e7eb; color:#111827; }
    .btn-danger { background: var(--danger); color: #fff; }

    /* ---------- Weekplanner header layout ---------- */
    .planner-header {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center; gap: 8px; margin-bottom: 12px;
    }
    .week-title { text-align: center; font-weight: 600; }
    .week-title .date { color: #374151; font-weight: 600; }
    .week-title .icon { margin-right: 6px; }

    .week-grid { display: grid; gap: 10px; grid-template-columns: repeat(7, 1fr); }
    @media (max-width: 820px) { .week-grid { grid-template-columns: 1fr; } }

    .day { background: #f8fafc; border: 2px solid #e5e7eb; border-radius: 12px; padding: 10px; min-height: 96px; display: flex; flex-direction: column; gap: 8px; }
    .day.today { border-color: var(--ok); background: #ecfdf5; }
    .day .head { display: flex; justify-content: space-between; font-weight: 600; font-size: 13px; color: #111827; }
    .day .date { font-size: 12px; color: var(--muted); }
    .day .meal {
      margin-top: 2px; flex:1; display:flex; align-items:center; justify-content:center;
      border:1px dashed #d1d5db; border-radius:8px; background:#fff; color:#6b7280; font-size: 14px;
      padding: 8px; text-align:center;
    }
    .day.has-meal .meal { border:1px solid #f59e0b; background:#fff7ed; color:#92400e; }

    .recipe-grid { display: grid; gap: 12px; grid-template-columns: 1fr; }
    @media (min-width: 720px) { .recipe-grid { grid-template-columns: repeat(2,1fr); } }
    .recipe { border:1px solid #e5e7eb; border-radius:10px; padding: 12px; background:#fff; cursor:pointer; }
    .recipe .top { display:flex; justify-content:space-between; gap:6px; }
    .recipe .title { font-weight:700; }
    .tags { display:flex; flex-wrap:wrap; gap:6px; margin:6px 0; }
    .tag { background:#fed7aa; color:#9a3412; font-size: 11px; padding: 2px 8px; border-radius:999px; }

    .shopping { max-height: 420px; overflow:auto; }
    .shop-row { display:flex; align-items:center; gap:10px; padding:8px; border-radius:8px; }
    .shop-row:hover { background: #f9fafb; }
    .shop-row.checked { color:#6b7280; text-decoration: line-through; }
    .shop-actions { margin-left:auto; display:flex; gap:8px; }
    .shop-edit { display:none; gap:6px; align-items:center; width:100%; }
    .shop-edit input { flex:1; padding:8px; border:1px solid #d1d5db; border-radius:8px; }

    .muted { color: var(--muted); }
    .empty { text-align:center; color: var(--muted); padding: 24px 8px; }

    /* Modal */
    .modal { position:fixed; inset:0; background: rgba(0,0,0,.5); display:flex; align-items:center; justify-content:center; padding:16px; z-index:999; }
    .modal-body { width:100%; max-width:620px; max-height:80vh; overflow:auto; background:#fff; border-radius:14px; padding:16px; }
    .row { display:grid; gap:10px; grid-template-columns: 1fr 1fr; }
    .row-1 { display:grid; gap:10px; grid-template-columns:1fr; }
    .field label { font-size:12px; color:#374151; font-weight:600; display:block; margin-bottom:6px; }
    .field input, .field textarea { width:100%; padding:10px; border:1px solid #d1d5db; border-radius:10px; }
    textarea { min-height:120px; resize:vertical; }

    .toggle { display:flex; gap:8px; margin-bottom: 8px; }
    .toggle .btn { flex:1; }
    .info { font-size: 12px; color:#065f46; background:#ecfdf5; border:1px solid #a7f3d0; padding:8px; border-radius:8px; }

    .inline { display:flex; align-items:center; gap:8px; }
    .between { display:flex; justify-content:space-between; gap:10px; align-items:center; }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>üçΩÔ∏è Avondeten Inspiratie</h1>
      <p class="muted">Ontdek, bewaar en plan jullie favoriete gerechten</p>
    </div>

    <div class="grid">
      <!-- Weekplanner -->
      <section class="card" style="grid-column: 1 / -1">
        <div class="planner-header">
          <button id="prevWeekBtn" class="btn btn-ghost">‚Üê Vorige week</button>
          <div class="week-title"><span class="icon">üìÖ</span><span id="weekRange" class="date"></span></div>
          <button id="nextWeekBtn" class="btn btn-ghost">Volgende week ‚Üí</button>
        </div>
        <div id="weekGrid" class="week-grid"></div>
      </section>

      <!-- Recepten -->
      <section class="card">
        <div class="between" style="margin-bottom:10px">
          <h2>Recepten Collectie</h2>
          <button id="addRecipeBtn" class="btn btn-prim">‚ûï Recept</button>
        </div>
        <div id="recipeGrid" class="recipe-grid"></div>
        <div id="recipesEmpty" class="empty">üç≥ Nog geen recepten. Klik op ‚ÄúRecept‚Äù om te beginnen.</div>
      </section>

      <!-- Boodschappenlijst -->
      <section class="card">
        <div class="between" style="margin-bottom:10px">
          <h2>Boodschappenlijst</h2>
          <div class="inline">
            <button id="copyListBtn" class="btn btn-prim" title="Kopieer ongevinkte items">üìã</button>
            <button id="clearListBtn" class="btn btn-danger" title="Wis lijst">üóëÔ∏è</button>
          </div>
        </div>
        <div id="shoppingList" class="shopping"></div>
        <div id="shoppingEmpty" class="empty">üõí Nog leeg. Voeg ingredi√´nten toe vanuit je recepten of weekplanning.</div>
      </section>
    </div>
  </div>

  <!-- Recept modal -->
  <div id="recipeModal" class="modal" style="display:none">
    <div class="modal-body">
      <div class="between" style="margin-bottom:6px">
        <h3 id="recipeModalTitle" style="margin:0">Nieuw recept</h3>
        <button id="recipeClose" class="btn btn-ghost">‚úñ</button>
      </div>

      <div class="toggle">
        <button id="manualBtn" class="btn btn-prim">‚úèÔ∏è Handmatig</button>
        <button id="urlBtn" class="btn btn-ghost">üîó Van URL</button>
      </div>

      <div id="urlSection" style="display:none; margin-bottom:10px">
        <div class="field">
          <label>Website URL *</label>
          <div class="inline" style="gap:8px">
            <input id="recipeUrl" type="url" placeholder="https://www.ah.nl/allerhande/recept/..." />
            <button id="extractBtn" class="btn btn-ok">üîç Ophalen</button>
          </div>
          <div id="extractStatus" class="muted" style="margin-top:6px"></div>
        </div>
      </div>

      <div id="portionBox" class="info" style="display:none; margin:8px 0">
        üçΩÔ∏è <strong>Aanpassen voor</strong>
        <span class="inline">
          <input id="newPortions" type="number" min="1" max="20" value="3" style="width:70px" />
          <span>personen</span>
          <button id="adjustBtn" class="btn btn-ghost">üîÑ Aanpassen</button>
        </span>
        <div id="portionNote" class="muted" style="margin-top:6px">Tip: past hoeveelheden in de ingredi√´nten automatisch aan (uitgaand van 4p basis).</div>
      </div>

      <div class="field"><label>Titel *</label><input id="title" type="text" placeholder="Pasta carbonara" /></div>
      <div class="row">
        <div class="field"><label>Bereidingstijd</label><input id="prepTime" type="text" placeholder="30 min" /></div>
        <div class="field"><label>Porties</label><input id="servings" type="text" placeholder="4 personen" /></div>
      </div>
      <div class="field"><label>Tags (komma)</label><input id="tags" type="text" placeholder="pasta, snel, italiaans" /></div>
      <div class="field"><label>Ingredi√´nten * (√©√©n per regel)</label><textarea id="ingredients" placeholder="200 g spaghetti\n100 g spek\n2 eieren"></textarea></div>
      <div class="field"><label>Bereidingswijze</label><textarea id="instructions" placeholder="Kook de pasta..."></textarea></div>

      <div class="between" style="margin-top:8px">
        <button id="recipeCancel" class="btn btn-ghost">Annuleren</button>
        <button id="recipeSave" class="btn btn-ok">Opslaan</button>
      </div>
    </div>
  </div>

  <!-- Dag / ingredi√´nten select modal -->
  <div id="dayModal" class="modal" style="display:none">
    <div class="modal-body">
      <div class="between" style="margin-bottom:6px">
        <h3 id="dayTitle" style="margin:0">Dag</h3>
        <button id="dayClose" class="btn btn-ghost">‚úñ</button>
      </div>

      <div id="daySelectWrap" class="field">
        <label>Kies recept</label>
        <select id="dayRecipeSelect"></select>
      </div>

      <div id="dayIngredientsWrap" style="display:none">
        <div class="between" style="margin: 6px 0 10px">
          <strong>Ingredi√´nten</strong>
          <div class="inline">
            <button id="addSelectedBtn" class="btn btn-ok">+ Geselecteerde naar lijst</button>
            <button id="addAllBtn" class="btn btn-prim">+ Alle naar lijst</button>
          </div>
        </div>
        <div id="dayIngredients"></div>
      </div>

      <div class="between" style="margin-top:10px">
        <button id="dayRemoveBtn" class="btn btn-danger" style="display:none">Verwijder uit dag</button>
        <div class="inline">
          <button id="dayCancel" class="btn btn-ghost">Sluiten</button>
          <button id="daySave" class="btn btn-ok">Opslaan</button>
        </div>
      </div>
    </div>
  </div>

  <script>
    /* ============================== Firebase ============================== */
    const firebaseConfig = {
      apiKey: "AIzaSyDwCytKLyfCWkaRvDoVVu_hUrTpuK3ef4Y",
      authDomain: "avondeten-inspiratie.firebaseapp.com",
      projectId: "avondeten-inspiratie",
      storageBucket: "avondeten-inspiratie.firebasestorage.app",
      messagingSenderId: "530227974284",
      appId: "1:530227974284:web:e101bcc416b51e0a58aba9",
      measurementId: "G-7JS0X2R3DB"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    /* ============================== State ============================== */
    let recipes = [];            // [{ id,title,prepTime,servings,tags[],ingredients[],instructions,dateAdded }]
    let shoppingList = [];       // [{ id, text, checked }]
    let weekPlan = {};           // { [weekKey-dayIndex]: { id, title } }

    let editingRecipeId = null;

    /* ============================== DOM ============================== */
    const recipeGrid = document.getElementById('recipeGrid');
    const recipesEmpty = document.getElementById('recipesEmpty');
    const addRecipeBtn = document.getElementById('addRecipeBtn');

    const shoppingListEl = document.getElementById('shoppingList');
    const shoppingEmpty = document.getElementById('shoppingEmpty');
    const copyListBtn = document.getElementById('copyListBtn');
    const clearListBtn = document.getElementById('clearListBtn');

    const weekGrid = document.getElementById('weekGrid');
    const weekRangeEl = document.getElementById('weekRange');
    const prevWeekBtn = document.getElementById('prevWeekBtn');
    const nextWeekBtn = document.getElementById('nextWeekBtn');

    // Recipe modal elements
    const recipeModal = document.getElementById('recipeModal');
    const recipeModalTitle = document.getElementById('recipeModalTitle');
    const recipeClose = document.getElementById('recipeClose');
    const recipeCancel = document.getElementById('recipeCancel');
    const recipeSave = document.getElementById('recipeSave');
    const manualBtn = document.getElementById('manualBtn');
    const urlBtn = document.getElementById('urlBtn');
    const urlSection = document.getElementById('urlSection');
    const extractBtn = document.getElementById('extractBtn');
    const extractStatus = document.getElementById('extractStatus');
    const portionBox = document.getElementById('portionBox');
    const newPortions = document.getElementById('newPortions');
    const adjustBtn = document.getElementById('adjustBtn');
    const portionNote = document.getElementById('portionNote');

    const titleEl = document.getElementById('title');
    const prepTimeEl = document.getElementById('prepTime');
    const servingsEl = document.getElementById('servings');
    const tagsEl = document.getElementById('tags');
    const ingredientsEl = document.getElementById('ingredients');
    const instructionsEl = document.getElementById('instructions');
    const recipeUrlEl = document.getElementById('recipeUrl');

    // Day modal elements
    const dayModal = document.getElementById('dayModal');
    const dayTitle = document.getElementById('dayTitle');
    const dayClose = document.getElementById('dayClose');
    const dayCancel = document.getElementById('dayCancel');
    const daySave = document.getElementById('daySave');
    const dayRemoveBtn = document.getElementById('dayRemoveBtn');
    const daySelectWrap = document.getElementById('daySelectWrap');
    const dayRecipeSelect = document.getElementById('dayRecipeSelect');
    const dayIngredientsWrap = document.getElementById('dayIngredientsWrap');
    const dayIngredientsEl = document.getElementById('dayIngredients');
    const addSelectedBtn = document.getElementById('addSelectedBtn');
    const addAllBtn = document.getElementById('addAllBtn');

    /* ============================== Helpers ============================== */
    const days = ['Maandag','Dinsdag','Woensdag','Donderdag','Vrijdag','Zaterdag','Zondag'];

    function getMonday(d){
      const x = new Date(d); const day = (x.getDay()+6)%7; // 0=ma
      x.setHours(0,0,0,0); x.setDate(x.getDate()-day); return x;
    }
    function clone(d){ return new Date(d.getTime()); }
    function addDays(d,n){ const x=clone(d); x.setDate(x.getDate()+n); return x; }
    function fmtShort(d){ return d.toLocaleDateString('nl-NL',{ day:'2-digit', month:'2-digit' }); }
    function weekKeyOf(d){ return `week-${d.getFullYear()}-${d.getMonth()+1}-${d.getDate()}`; }

    // we laten max 2 weken bestaan: current (offset 0) en previous (offset -1)
    let weekOffset = 0; // 0 = huidige week, -1 = vorige
    function currentWeekStart(){ return addDays( getMonday(new Date()), 7*weekOffset ); }

    function pruneWeekPlan(){
      const cur = weekKeyOf(getMonday(new Date()));
      const prevStart = addDays(getMonday(new Date()), -7);
      const prev = weekKeyOf(prevStart);
      const keep = new Set([cur, prev]);
      const nextPlan = {};
      Object.keys(weekPlan).forEach(k => {
        const wk = k.split('-').slice(0,4).join('-'); // week-YYYY-M-D
        if(keep.has(wk)) nextPlan[k] = weekPlan[k];
      });
      weekPlan = nextPlan;
    }

    function saveRecipes(){
      return db.collection('recipes').doc('shared').set({ recipes, lastUpdated: new Date() })
        .catch(()=> localStorage.setItem('recipes', JSON.stringify(recipes)) );
    }
    function saveShopping(){
      return db.collection('shopping').doc('shared').set({ items: shoppingList, lastUpdated: new Date() })
        .catch(()=> localStorage.setItem('shoppingList', JSON.stringify(shoppingList)) );
    }
    function saveWeek(){ pruneWeekPlan();
      return db.collection('weekplan').doc('shared').set({ plan: weekPlan, lastUpdated: new Date() })
        .catch(()=> localStorage.setItem('weekPlan', JSON.stringify(weekPlan)) );
    }

    async function loadAll(){
      try {
        const r = await db.collection('recipes').doc('shared').get();
        recipes = r.exists ? (r.data().recipes||[]) : [];
      } catch {
        recipes = JSON.parse(localStorage.getItem('recipes')||'[]');
      }
      try {
        const s = await db.collection('shopping').doc('shared').get();
        shoppingList = s.exists ? (s.data().items||[]) : [];
      } catch {
        shoppingList = JSON.parse(localStorage.getItem('shoppingList')||'[]');
      }
      try {
        const w = await db.collection('weekplan').doc('shared').get();
        weekPlan = w.exists ? (w.data().plan||{}) : {};
      } catch {
        weekPlan = JSON.parse(localStorage.getItem('weekPlan')||'{}');
      }
      renderAll();
    }

    /* ============================== Weekplanner ============================== */
    function renderWeekNav(){
      const start = currentWeekStart();
      const end = addDays(start, 6);
      weekRangeEl.textContent = `${fmtShort(start)} ‚Äì ${fmtShort(end)}`;
      // beperk navigatie: alleen 0 en -1 toegelaten
      prevWeekBtn.style.visibility = (weekOffset <= -1) ? 'hidden' : 'visible';
      nextWeekBtn.style.visibility = (weekOffset >= 0) ? 'hidden' : 'visible';
    }

    function renderWeek(){
      renderWeekNav();
      weekGrid.innerHTML = '';
      const start = currentWeekStart();
      const todayStr = new Date().toDateString();
      const keyBase = weekKeyOf(start);
      for(let i=0;i<7;i++){
        const d = addDays(start, i);
        const isToday = (weekOffset===0 && d.toDateString()===todayStr);
        const dayKey = `${keyBase}-${i}`;
        const planned = weekPlan[dayKey];

        const div = document.createElement('div');
        div.className = `day ${isToday? 'today':''} ${planned? 'has-meal':''}`;
        div.innerHTML = `
          <div class="head"><span>${days[i]}</span><span class="date">${fmtShort(d)}</span></div>
          <div class="meal">${planned ? planned.title : 'Klik om gerecht te kiezen'}</div>
        `;
        div.addEventListener('click', ()=> openDayModal(dayKey, d, planned));
        weekGrid.appendChild(div);
      }
    }

    prevWeekBtn.addEventListener('click', ()=>{ if(weekOffset>-1){ weekOffset--; renderWeek(); } });
    nextWeekBtn.addEventListener('click', ()=>{ if(weekOffset<0){ weekOffset++; renderWeek(); } });

    // Day modal
    let currentDayKey = null;
    function openDayModal(dayKey, date, planned){
      currentDayKey = dayKey;
      dayTitle.textContent = `${days[(date.getDay()+6)%7]} ‚Ä¢ ${fmtShort(date)}`;
      dayRecipeSelect.innerHTML = `<option value="">Kies een recept‚Ä¶</option>` +
        recipes.map(r=>`<option value="${r.id}">${escapeHtml(r.title)}</option>`).join('');
      daySelectWrap.style.display = 'block';
      dayIngredientsWrap.style.display = 'none';
      dayRemoveBtn.style.display = planned ? 'inline-flex' : 'none';
      if(planned){ dayRecipeSelect.value = planned.id; showDayIngredients(planned.id); }
      dayModal.style.display='flex';
    }

    function closeDayModal(){ dayModal.style.display='none'; currentDayKey=null; dayIngredientsEl.innerHTML=''; }
    dayClose.addEventListener('click', closeDayModal); dayCancel.addEventListener('click', closeDayModal);

    dayRecipeSelect.addEventListener('change', () => {
      const id = parseInt(dayRecipeSelect.value); if(!id) { dayIngredientsWrap.style.display='none'; return; }
      showDayIngredients(id);
    });

    function showDayIngredients(recipeId){
      const r = recipes.find(x=>x.id===parseInt(recipeId)); if(!r){ dayIngredientsWrap.style.display='none'; return; }
      dayIngredientsWrap.style.display = 'block';
      dayIngredientsEl.innerHTML = r.ingredients.map((t,idx)=>{
        return `<label class="inline" style="gap:8px; padding:6px 0">
          <input type="checkbox" data-idx="${idx}" checked />
          <span>${escapeHtml(t)}</span>
        </label>`;
      }).join('');
    }

    daySave.addEventListener('click', () => {
      const id = parseInt(dayRecipeSelect.value); if(!id){ alert('Kies eerst een recept'); return; }
      const r = recipes.find(x=>x.id===id); if(!r) return;
      weekPlan[currentDayKey] = { id: r.id, title: r.title };
      saveWeek().then(()=>{ renderWeek(); closeDayModal(); });
    });

    dayRemoveBtn.addEventListener('click', () => {
      if(currentDayKey && weekPlan[currentDayKey]){
        delete weekPlan[currentDayKey];
        saveWeek().then(()=>{ renderWeek(); closeDayModal(); });
      }
    });

    addSelectedBtn.addEventListener('click', () => addFromDaySelection(false));
    addAllBtn.addEventListener('click', () => addFromDaySelection(true));

    function addFromDaySelection(all){
      const id = parseInt(dayRecipeSelect.value); const r = recipes.find(x=>x.id===id); if(!r) return;
      let toAdd = [];
      if(all){ toAdd = r.ingredients; }
      else {
        const checks = dayIngredientsEl.querySelectorAll('input[type="checkbox"]');
        checks.forEach(ch => { if(ch.checked){ const i = parseInt(ch.getAttribute('data-idx')); toAdd.push(r.ingredients[i]); } });
      }
      if(toAdd.length){
        const items = toAdd.map(t=>({ id: Date.now()+Math.random(), text: t, checked:false }));
        shoppingList.push(...items);
        saveShopping().then(renderShopping);
        alert(`Toegevoegd: ${toAdd.length} item(s)`);
      }
    }

    /* ============================== Recepten ============================== */
    addRecipeBtn.addEventListener('click', () => openRecipeModal());

    function openRecipeModal(toEdit){
      recipeModalTitle.textContent = toEdit ? 'Recept bewerken' : 'Nieuw recept';
      recipeModal.style.display='flex';
      manualMode();
      portionBox.style.display = toEdit ? 'block' : 'none';
    }
    function closeRecipeModal(){ recipeModal.style.display='none'; clearRecipeForm(); editingRecipeId=null; }
    recipeClose.addEventListener('click', closeRecipeModal); recipeCancel.addEventListener('click', closeRecipeModal);

    function clearRecipeForm(){ titleEl.value=''; prepTimeEl.value=''; servingsEl.value=''; tagsEl.value=''; ingredientsEl.value=''; instructionsEl.value=''; recipeUrlEl.value=''; extractStatus.textContent=''; }

    function manualMode(){ urlSection.style.display='none'; manualBtn.className='btn btn-prim'; urlBtn.className='btn btn-ghost'; }
    function urlMode(){ urlSection.style.display='block'; manualBtn.className='btn btn-ghost'; urlBtn.className='btn btn-prim'; }
    manualBtn.addEventListener('click', manualMode); urlBtn.addEventListener('click', urlMode);

    recipeSave.addEventListener('click', () => {
      const title = titleEl.value.trim(); const ing = ingredientsEl.value.trim();
      if(!title || !ing){ alert('Vul minimaal titel en ingredi√´nten in'); return; }
      const rec = {
        id: editingRecipeId || Date.now(),
        title,
        prepTime: prepTimeEl.value.trim(),
        servings: servingsEl.value.trim(),
        tags: tagsEl.value.split(',').map(t=>t.trim()).filter(Boolean),
        ingredients: ing.split('\n').map(s=>s.trim()).filter(Boolean),
        instructions: instructionsEl.value.trim(),
        dateAdded: editingRecipeId ? (recipes.find(r=>r.id===editingRecipeId)?.dateAdded || new Date().toLocaleDateString('nl-NL')) : new Date().toLocaleDateString('nl-NL')
      };
      if(editingRecipeId){ const i=recipes.findIndex(r=>r.id===editingRecipeId); if(i>-1) recipes[i]=rec; }
      else { recipes.unshift(rec); }
      saveRecipes().then(()=>{ renderRecipes(); closeRecipeModal(); });
    });

    function editRecipe(id){
      const r = recipes.find(x=>x.id===id); if(!r) return;
      editingRecipeId = id; openRecipeModal(true);
      titleEl.value = r.title; prepTimeEl.value=r.prepTime||''; servingsEl.value=r.servings||'';
      tagsEl.value = (r.tags||[]).join(', '); ingredientsEl.value=(r.ingredients||[]).join('\n'); instructionsEl.value=r.instructions||'';
      portionBox.style.display='block';
    }

    function deleteRecipe(id){ if(!confirm('Weet je zeker dat je dit recept wilt verwijderen?')) return;
      recipes = recipes.filter(r=>r.id!==id); saveRecipes().then(renderRecipes);
    }

    function addToShopping(recipeId){
      const r = recipes.find(x=>x.id===recipeId); if(!r) return;
      const items = r.ingredients.map(t=>({ id: Date.now()+Math.random(), text: t.replace(/^[-‚Ä¢]\s*/,''), checked:false }));
      shoppingList.push(...items); saveShopping().then(renderShopping);
    }

    function viewRecipe(id){ const r=recipes.find(x=>x.id===id); if(!r) return; alert(`${r.title}\n\nIngredi√´nten:\n${r.ingredients.join('\n')}\n\nBereiding:\n${r.instructions||'-'}`); }

    function renderRecipes(){
      if(!recipes.length){ recipeGrid.innerHTML=''; recipesEmpty.style.display='block'; return; }
      recipesEmpty.style.display='none';
      recipeGrid.innerHTML = recipes.map(r=>`
        <div class="recipe" onclick="viewRecipe(${r.id})">
          <div class="top">
            <div class="title">${escapeHtml(r.title)}</div>
            <div class="inline" style="gap:6px">
              <button class="btn btn-ghost" onclick="event.stopPropagation(); editRecipe(${r.id})">‚úèÔ∏è</button>
              <button class="btn btn-danger" onclick="event.stopPropagation(); deleteRecipe(${r.id})">üóëÔ∏è</button>
            </div>
          </div>
          <div class="muted" style="font-size:12px; margin:4px 0">${r.prepTime?`‚è±Ô∏è ${escapeHtml(r.prepTime)}`:''} ${r.servings?` ‚Ä¢ üë• ${escapeHtml(r.servings)}`:''}</div>
          ${(r.tags&&r.tags.length)?`<div class="tags">${r.tags.map(t=>`<span class=tag>${escapeHtml(t)}</span>`).join('')}</div>`:''}
          <div class="between" style="margin-top:6px">
            <span class="muted" style="font-size:12px">Toegevoegd: ${escapeHtml(r.dateAdded)}</span>
            <button class="btn btn-ghost" onclick="event.stopPropagation(); addToShopping(${r.id})">+ Boodschappen</button>
          </div>
        </div>`).join('');
    }

    // Portion adjust (assume base 4 ‚Üí newPortions)
    adjustBtn.addEventListener('click', () => {
      const np = parseInt(newPortions.value,10); if(!np || np<1){ alert('Geef een geldig aantal personen'); return; }
      const lines = ingredientsEl.value.split('\n');
      const base = 4; const mul = np/base; const re = /^(\d+(?:[\.,]\d+)?)\s*(gram|g|ml|liter|l|kg|stuks?|eetlepels?|theelepels?|el|tl)\b/i;
      const out = lines.map(s=> s.replace(re, (m,a,unit)=>{
        const num = parseFloat(String(a).replace(',','.')); const val = Math.round(num*mul*10)/10; return `${val} ${unit}`;
      }));
      ingredientsEl.value = out.join('\n');
      servingsEl.value = `${np} personen`;
      portionNote.textContent = `‚úÖ Ingredi√´nten aangepast voor ${np} personen.`;
    });

    // URL extraction
    extractBtn?.addEventListener('click', async () => {
      const url = (recipeUrlEl.value||'').trim(); if(!url){ alert('Vul eerst een URL in'); return; }
      try{
        extractStatus.textContent = 'Ophalen‚Ä¶';
        const data = await extractRecipeFromUrl(url);
        if(data.success){
          titleEl.value = data.title||'';
          prepTimeEl.value = data.prepTime||'';
          servingsEl.value = data.servings||'';
          ingredientsEl.value = data.ingredients||'';
          instructionsEl.value = data.instructions||'';
          tagsEl.value = data.tags||'';
          portionBox.style.display = 'block';
          extractStatus.textContent = `‚úÖ Gevonden (${data.confidence}%)`;
        } else {
          extractStatus.textContent = `‚ùå ${data.error||'Geen receptgegevens gevonden'}`;
        }
      } catch(err){ extractStatus.textContent = '‚ùå Fout bij ophalen'; }
    });

    function manualOrUrl(){ return urlSection.style.display==='block' ? 'url' : 'manual'; }

    function escapeHtml(s){ return String(s).replace(/[&<>"']/g, c=>({"&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;"}[c])); }

    function extractFromJsonLd(doc){
      try{
        const scripts = doc.querySelectorAll('script[type="application/ld+json"]');
        for(const sc of scripts){
          try{
            const data = JSON.parse(sc.textContent);
            const arr = Array.isArray(data)?data:[data];
            for(const item of arr){
              const graph = item['@graph'];
              const node = (item['@type']==='Recipe') ? item : (Array.isArray(graph)?graph.find(g=>g['@type']==='Recipe'):null);
              if(node){
                const ing = node.recipeIngredient ? (Array.isArray(node.recipeIngredient)?node.recipeIngredient.join('\n'):node.recipeIngredient) : '';
                const instr = node.recipeInstructions ? (Array.isArray(node.recipeInstructions)?node.recipeInstructions.map(x=>x.text||x).join('\n'):node.recipeInstructions) : '';
                return { success:true, title: node.name||'', ingredients: ing, instructions: instr, prepTime: node.prepTime||node.totalTime||'', servings: node.recipeYield||node.yield||'', tags: node.recipeCategory||node.recipeCuisine||'' };
              }
            }
          }catch(e){}
        }
      }catch(e){}
      return { success:false };
    }

    function extractFromAllerhande(doc){
      try{
        const title = (doc.querySelector('h1, [data-testhook="recipe-title"], .recipe-header__title')?.textContent||'').trim();
        const ingSel = ['[data-testhook="recipe-ingredient"]','.recipe-ingredients__item','.ingredients-list__item','.recipe-ingredient','li[class*="ingredient"]'];
        let ingredients = '';
        for(const sel of ingSel){ const els = doc.querySelectorAll(sel); if(els.length){ ingredients = [...els].map(e=>e.textContent.trim().replace(/\s+/g,' ')).filter(Boolean).join('\n'); if(ingredients) break; } }
        const stepSel = ['[data-testhook="recipe-instruction"]','.recipe-method__step','.recipe-instructions__step','ol li','.steps li'];
        let instructions='';
        for(const sel of stepSel){ const els = doc.querySelectorAll(sel); if(els.length){ instructions = [...els].map((e,i)=>`${i+1}. ${e.textContent.trim().replace(/\s+/g,' ')}`).join('\n\n'); if(instructions) break; } }
        let servings = (doc.querySelector('[data-testhook="recipe-portions"], .servings, .yield, [class*="portion"], [class*="serving"]')?.textContent||'').trim();
        let prepTime = (doc.querySelector('[data-testhook="recipe-duration"], .recipe-time, [class*="time"]')?.textContent||'').trim();
        if(title && (ingredients || instructions)) return { success:true, title, ingredients: ingredients||'', instructions: instructions||'', servings, prepTime, tags:'allerhande' };
      }catch(e){}
      return { success:false };
    }

    function extractFromSmulweb(doc){
      try{
        const title = (doc.querySelector('h1, .recipe-title')?.textContent||'').trim();
        const ingredients = [...doc.querySelectorAll('.ingredients li, .recipe-ingredients li')].map(e=>e.textContent.trim()).join('\n');
        const instructions = [...doc.querySelectorAll('.directions li, .instructions li, .recipe-method li, ol li')].map((e,i)=>`${i+1}. ${e.textContent.trim()}`).join('\n\n');
        if(title && ingredients) return { success:true, title, ingredients, instructions, tags:'smulweb' };
      }catch(e){}
      return { success:false };
    }

    function extractFromGeneric(doc){
      try{
        let title=''; for(const s of ['h1','.recipe-title','.entry-title','title']){ const el=doc.querySelector(s); if(el){ title=(el.textContent||'').trim(); if(title.length>3) break; } }
        let ingredients='';
        const groups=['.ingredients li','.recipe-ingredients li','ul li','ol li','li[class*="ingredient"]'];
        for(const sel of groups){ const els=doc.querySelectorAll(sel); if(els.length>=3){ const arr=[...els].map(e=>e.textContent.trim().replace(/\s+/g,' ')).filter(t=>/\d|gram|ml|liter|stuks|eetlepel|theelepel|kg|pond/i.test(t)||t.length<50); if(arr.length>=3){ ingredients=arr.join('\n'); break; } } }
        let instructions=''; for(const sel of ['.instructions li','.recipe-method li','.directions li','ol li']){ const els=doc.querySelectorAll(sel); if(els.length>=2){ instructions=[...els].map((e,i)=>`${i+1}. ${e.textContent.trim()}`).join('\n\n'); if(instructions) break; } }
        if(title && (ingredients||instructions)) return { success:true, title, ingredients, instructions, tags:'generic' };
      }catch(e){}
      return { success:false };
    }

    async function extractRecipeFromUrl(url){
      try{
        const proxies=[
          `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
          `https://corsproxy.io/?${encodeURIComponent(url)}`,
          `https://api.allorigins.win/get?url=${encodeURIComponent(url)}`
        ];
        let html=null;
        for(const p of proxies){
          try{
            const res = await fetch(p);
            if(!res.ok) continue; const txt = await res.text();
            if(p.includes('allorigins')){ const j=JSON.parse(txt); html=j.contents; } else { html=txt; }
            if(html && html.length>500) break;
          }catch(e){}
        }
        if(!html) return { success:false, error:'Website laden mislukt (CORS/anti-bot). Probeer kopi√´ren/plakken.' };
        const parser = new DOMParser(); const doc = parser.parseFromString(html,'text/html');
        let x = extractFromJsonLd(doc); if(x.success) return { ...x, confidence:95 };
        if(/allerhande|ah\.nl/.test(url)){ x = extractFromAllerhande(doc); if(x.success) return { ...x, confidence:85 }; }
        if(/smulweb\.nl/.test(url)){ x = extractFromSmulweb(doc); if(x.success) return { ...x, confidence:85 }; }
        x = extractFromGeneric(doc); if(x.success) return { ...x, confidence:60 };
        return { success:false, error:'Geen receptgegevens gevonden' };
      }catch(e){ return { success:false, error:'Technische fout' } }
    }

    /* ============================== Boodschappenlijst ============================== */
    function toggleItem(id){ const it = shoppingList.find(x=>x.id===id); if(it){ it.checked=!it.checked; saveShopping().then(renderShopping); } }

    function startEditItem(id){ const row = document.querySelector(`[data-row="${id}"]`); if(!row) return;
      row.querySelector('.shop-view').style.display='none';
      row.querySelector('.shop-edit').style.display='flex';
      row.querySelector('input[type="text"]').focus();
    }
    function cancelEditItem(id){ const row = document.querySelector(`[data-row="${id}"]`); if(!row) return;
      row.querySelector('.shop-view').style.display='flex';
      row.querySelector('.shop-edit').style.display='none';
    }
    function saveEditItem(id){ const row = document.querySelector(`[data-row="${id}"]`); if(!row) return;
      const val = row.querySelector('input[type="text"]').value.trim();
      const it = shoppingList.find(x=>x.id===id); if(it && val){ it.text = val; saveShopping().then(renderShopping); }
    }
    function removeItem(id){ shoppingList = shoppingList.filter(x=>x.id!==id); saveShopping().then(renderShopping); }

    copyListBtn.addEventListener('click', () => {
      const txt = shoppingList.filter(x=>!x.checked).map(x=>x.text).join('\n');
      if(txt) navigator.clipboard.writeText(txt).then(()=> alert('Boodschappenlijst gekopieerd!')); else alert('Niets om te kopi√´ren.');
    });
    clearListBtn.addEventListener('click', () => { if(confirm('Hele lijst wissen?')){ shoppingList=[]; saveShopping().then(renderShopping); } });

    function renderShopping(){
      if(!shoppingList.length){ shoppingListEl.innerHTML=''; shoppingEmpty.style.display='block'; return; }
      shoppingEmpty.style.display='none';
      shoppingListEl.innerHTML = shoppingList.map(it=>`
        <div class="shop-row ${it.checked?'checked':''}" data-row="${it.id}">
          <input type="checkbox" ${it.checked?'checked':''} onclick="toggleItem(${it.id})" />
          <div class="shop-view" style="display:flex; align-items:center; gap:10px; width:100%">
            <span>${escapeHtml(it.text)}</span>
            <div class="shop-actions">
              <button class="btn btn-ghost" onclick="startEditItem(${it.id})">‚úèÔ∏è</button>
              <button class="btn btn-danger" onclick="removeItem(${it.id})">üóëÔ∏è</button>
            </div>
          </div>
          <div class="shop-edit">
            <input type="text" value="${escapeHtml(it.text)}" />
            <button class="btn btn-ok" onclick="saveEditItem(${it.id})">Opslaan</button>
            <button class="btn btn-ghost" onclick="cancelEditItem(${it.id})">Annuleren</button>
          </div>
        </div>`).join('');
    }

    /* ============================== Render root ============================== */
    function renderAll(){ renderRecipes(); renderShopping(); renderWeek(); }

    /* ============================== SW register ============================== */
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('/sw.js').catch(()=>{});
    }

    /* ============================== Expose to window (for inline handlers) ============================== */
    window.viewRecipe = viewRecipe;
    window.deleteRecipe = deleteRecipe;
    window.editRecipe = editRecipe;
    window.addToShopping = addToShopping;
    window.toggleItem = toggleItem;
    window.startEditItem = startEditItem;
    window.cancelEditItem = cancelEditItem;
    window.saveEditItem = saveEditItem;
    window.removeItem = removeItem;

    // Init
    loadAll();
  </script>
</body>
</html>
